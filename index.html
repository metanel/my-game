<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק החיסכון</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            background-color: #87CEEB;
            touch-action: none;
        }
        .game-display {
            position: absolute;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #score-display {
            top: 10px;
            right: 10px;
        }
        #date-display {
            top: 10px;
            left: 10px;
        }
        #tutorial-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            max-width: 80%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .dialog-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .dialog-box h3 {
            margin-top: 0;
            color: #2a6496;
        }
        .dialog-box button {
            margin: 5px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .dialog-box button:hover {
            background-color: #45a049;
        }
        .dialog-box button.no-btn {
            background-color: #f44336;
        }
        .dialog-box button.no-btn:hover {
            background-color: #d32f2f;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 80%;
            max-width: 450px;
        }
        #game-over button,
        #win-screen button {
            margin-top: 20px;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #game-over button:hover,
        #win-screen button:hover {
            background-color: #45a049;
        }
        #win-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(25, 118, 210, 0.9);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 80%;
            max-width: 450px;
        }
        .speech-bubble {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.9);
            border: 2px solid #333;
            border-radius: 10px;
            padding: 8px;
            font-size: 14px;
            width: 120px;
            text-align: center;
            z-index: 5;
            word-wrap: break-word;
        }
        .speech-bubble:after {
            content: "";
            position: absolute;
            bottom: -10px;
            left: 50%;
            margin-left: -5px;
            border-width: 10px 5px 0;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        #monthly-stats {
            position: absolute;
            top: 60px;
            right: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 14px;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }
        #achievements {
            position: absolute;
            top: 60px;
            left: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 14px;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: none;
        }
        .achievement {
            padding: 5px;
            margin-bottom: 5px;
            background-color: rgba(76, 175, 80, 0.2);
            border-radius: 4px;
        }
        .popup-message {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 20px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 20;
        }
        .power-meter {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 15px;
            background-color: #ccc;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        .power-meter-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.1s linear;
        }
        @media (max-width: 600px) {
            .game-display {
                font-size: 14px;
                padding: 8px;
            }
            .dialog-box {
                width: 95%;
                max-width: 350px;
                padding: 15px;
            }
            .dialog-box h3 {
                font-size: 16px;
            }
            .dialog-box button {
                padding: 8px 16px;
                font-size: 14px;
            }
            #tutorial-message {
                font-size: 14px;
                max-width: 95%;
            }
            .power-meter {
                width: 150px;
                height: 12px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="score-display" class="game-display">חיסכון: 0 ש"ח</div>
        <div id="date-display" class="game-display">מרץ 2025</div>
        <div id="monthly-stats">
            <div>הוצאות: <span id="expenses">0</span> ש"ח</div>
            <div>הכנסות: <span id="income">0</span> ש"ח</div>
        </div>
        <div id="achievements"></div>
        <div id="power-meter" class="power-meter">
            <div id="power-meter-fill" class="power-meter-fill"></div>
        </div>
        <div id="popup-message" class="popup-message"></div>
        
        <div id="tutorial-message">
            <h3>ברוכים הבאים למשחק החיסכון!</h3>
            <p>המטרה שלך היא לצבור 100,000 ש"ח על ידי התחמקות ממכשולים ואיסוף חיזוקים.</p>
            <p>לחץ על המסך או על מקש הרווח כדי לקפוץ מעל מכשולים.</p>
            <p>אתה מרוויח 5,000 ש"ח בכל חודש, אבל היזהר מפיתויים להוציא כסף!</p>
            <button id="start-btn">התחל לשחק</button>
        </div>
        
        <div id="job-offer" class="dialog-box">
            <h3>הצעת עבודה חדשה!</h3>
            <p>האם אתה רוצה להחליף את העבודה שלך בעבודה אחרת מאוד מפתה?</p>
            <button id="yes-btn">כן</button>
            <button id="no-btn" class="no-btn">לא</button>
        </div>
        
        <div id="job-offer-followup" class="dialog-box">
            <h3>אולי תשקול שוב?</h3>
            <p id="followup-text">האם אתה בטוח שאתה לא רוצה להחליף את העבודה שלך?</p>
            <button id="followup-yes-btn">כן</button>
            <button id="followup-no-btn" class="no-btn">לא</button>
        </div>
        
        <div id="game-over">
            <h2>המשחק נגמר!</h2>
            <p id="game-over-reason"></p>
            <p>הגעת לחיסכון של <span id="final-score">0</span> ש"ח</p>
            <div id="game-stats">
                <p>שיחקת <span id="months-played">0</span> חודשים</p>
                <p>אספת <span id="powerups-collected">0</span> חיזוקים</p>
                <p>התחמקת מ-<span id="obstacles-avoided">0</span> מכשולים</p>
            </div>
            <button id="restart-btn">התחל מחדש</button>
        </div>
        
        <div id="win-screen">
            <h2>ניצחון!</h2>
            <p>הצלחת להגיע ליעד של 100,000 ש"ח!</p>
            <p>כל הכבוד על ההתמדה וקבלת ההחלטות הנכונות!</p>
            <div id="win-stats">
                <p>השלמת את המשחק ב-<span id="win-months">0</span> חודשים</p>
                <p>אספת <span id="win-powerups">0</span> חיזוקים</p>
                <p>התחמקת מ-<span id="win-obstacles">0</span> מכשולים</p>
            </div>
            <button id="play-again-btn">שחק שוב</button>
        </div>
    </div>

    <script>
        // Canvas and context setup
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas to cover the window
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Game variables
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let currentMonth = 0;
        let tutorialShown = true;
        
        // Game statistics
        let stats = {
            monthsPlayed: 0,
            powerupsCollected: 0,
            obstaclesAvoided: 0,
            expenses: 0,
            income: 5000  // Starting monthly income
        };
        
        // Achievements
        let achievements = {
            firstMonth: { earned: false, text: "הישרדות חודש ראשון" },
            saveHero: { earned: false, text: "חסכת 50,000 ש\"ח" },
            powerCollector: { earned: false, text: "אספת 10 חיזוקים" },
            obstacleNinja: { earned: false, text: "התחמקת מ-20 מכשולים" }
        };
        
        const totalMonths = 20; // From March 2025 to November 2026
        const monthNames = [
            "מרץ 2025", "אפריל 2025", "מאי 2025", "יוני 2025", "יולי 2025", 
            "אוגוסט 2025", "ספטמבר 2025", "אוקטובר 2025", "נובמבר 2025", "דצמבר 2025",
            "ינואר 2026", "פברואר 2026", "מרץ 2026", "אפריל 2026", "מאי 2026", 
            "יוני 2026", "יולי 2026", "אוגוסט 2026", "ספטמבר 2026", "אוקטובר 2026", "נובמבר 2026"
        ];
        
        // Month duration is now more reasonable - 30 seconds per month
        const monthDuration = 30; // 30 seconds
        const framesPerSecond = 60;
        const frameTime = 1000 / framesPerSecond;
        const framesPerMonth = monthDuration * framesPerSecond;
        let currentMonthTimer = 0;
        
        // Power-up variables
        const maxPowerUpTime = 300; // 5 seconds at 60fps
        let gameMessage = '';
        let gameMessageTime = 0;
        
        // Player variables
        const player = {
            x: canvas.width * 0.2,
            y: canvas.height * 0.7,
            width: 50,
            height: 80,
            jumping: false,
            jumpPower: 15,
            jumpVelocity: 0,
            gravity: 0.5,
            speed: 5,
            powerUp: false,
            powerUpTime: 0,
            powerUpHits: 0,
            powerUpType: '',
            companion: false
        };
        
        // Ground variables
        const ground = {
            y: canvas.height * 0.8,
            width: canvas.width,
            height: canvas.height * 0.2
        };
        
        // Arrays for game objects
        let obstacles = [];
        let powerups = [];
        let pendingObstacles = [];  // For delayed creation
        
        // Job offer variables
        let jobOfferStage = 0;
        const jobOfferTexts = [
            "האם אתה בטוח שאתה לא רוצה להחליף את העבודה שלך?",
            "היא באמת שווה ומשלמת יותר!",
            "אפשר להרוויח שם יותר כסף!",
            "היא יותר קלילה ופחות שעות עבודה!"
        ];
        
        // Helper for random number generation
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // Display popup message
        function showPopupMessage(message, duration = 2000) {
            const popup = document.getElementById('popup-message');
            popup.textContent = message;
            popup.style.opacity = '1';
            
            setTimeout(() => {
                popup.style.opacity = '0';
            }, duration);
        }
        
        // Create obstacle
        function createObstacle() {
            const types = ['person', 'ad', 'food'];
            const type = types[getRandomInt(0, types.length - 1)];
            
            let obstacle;
            
            if (type === 'person') {
                const negativeComments = [
                    "אתה לא טוב מספיק",
                    "אתה לא יכול לחסוך",
                    "זה גדול עליך",
                    "למה שתצליח?",
                    "אין לך מספיק משמעת"
                ];
                
                obstacle = {
                    x: canvas.width,
                    y: ground.y - 80,
                    width: 50,
                    height: 80,
                    type: type,
                    speed: 5 + (currentMonth * 0.1), // Increases with time
                    text: negativeComments[getRandomInt(0, negativeComments.length - 1)],
                    value: getRandomInt(500, 1000) // Cost if hit
                };
            } else if (type === 'ad') {
                const adTexts = [
                    "תבזבז!",
                    "תקנה עכשיו!",
                    "אתה חייב בגדים חדשים!",
                    "חופשה מושלמת ב-70% הנחה!",
                    "קורס שיעזור לך להרוויח יותר!",
                    "רק קפה קטן, זה לא יזיק לחיסכון!"
                ];
                
                obstacle = {
                    x: canvas.width,
                    y: ground.y - 70,
                    width: 60,
                    height: 70,
                    type: type,
                    speed: 6 + (currentMonth * 0.15),
                    text: adTexts[getRandomInt(0, adTexts.length - 1)],
                    value: getRandomInt(1000, 2000)
                };
            } else if (type === 'food') {
                const foodTypes = [
                    "אוכל יקר במסעדה",
                    "ממתקים וחטיפים",
                    "משקאות מוגזים",
                    "קניות במכולת יקרה",
                    "משלוחים במקום לבשל"
                ];
                
                obstacle = {
                    x: canvas.width,
                    y: ground.y - 60,
                    width: 50,
                    height: 60,
                    type: type,
                    speed: 4 + (currentMonth * 0.1),
                    text: foodTypes[getRandomInt(0, foodTypes.length - 1)],
                    value: getRandomInt(300, 800)
                };
            }
            
            obstacles.push(obstacle);
        }
        
        // Create powerup
        function createPowerup() {
            const types = ['money', 'earlyRise', 'earlySleep', 'healthyFood', 'exercise'];
            const type = types[getRandomInt(0, types.length - 1)];
            
            let text = '';
            let width = 40;
            let height = 40;
            let value = 1000;
            
            switch(type) {
                case 'money':
                    text = "בונוס כספי";
                    value = getRandomInt(1000, 3000);
                    break;
                case 'earlyRise':
                    text = "קימה מוקדם";
                    break;
                case 'earlySleep':
                    text = "שינה מוקדמת";
                    break;
                case 'healthyFood':
                    text = "אוכל בריא";
                    break;
                case 'exercise':
                    text = "אימון יומי";
                    break;
            }
            
            const powerup = {
                x: canvas.width,
                y: getRandomInt(ground.y - 150, ground.y - 60),
                width: width,
                height: height,
                type: type,
                speed: 5,
                text: text,
                value: value
            };
            
            powerups.push(powerup);
        }
        
        // Create companion
        function createCompanion() {
            const companion = {
                x: canvas.width,
                y: ground.y - 70,
                width: 40,
                height: 70,
                speed: 5,
                type: 'companion',
                text: "אני ארוץ איתך ביחד!"
            };
            
            powerups.push(companion);
            showPopupMessage("חבר לריצה מתקרב!");
        }
        
        // Apply powerup effect
        function applyPowerup(powerup) {
            stats.powerupsCollected++;
            
            switch(powerup.type) {
                case 'money':
                    score += powerup.value;
                    stats.income += powerup.value;
                    showPopupMessage(`קיבלת ${powerup.value} ש"ח!`, 1500);
                    updateDisplay();
                    break;
                case 'earlyRise':
                case 'earlySleep':
                case 'healthyFood':
                case 'exercise':
                    player.powerUp = true;
                    player.powerUpTime = maxPowerUpTime;
                    player.powerUpType = powerup.type;
                    document.getElementById('power-meter').style.display = 'block';
                    showPopupMessage(`חיזוק פעיל: ${powerup.text}!`, 1500);
                    break;
                case 'companion':
                    player.companion = true;
                    player.powerUp = true;
                    player.powerUpTime = maxPowerUpTime * 2; // Companion lasts longer
                    player.powerUpType = 'companion';
                    document.getElementById('power-meter').style.display = 'block';
                    showPopupMessage("חבר לריצה מצטרף אליך!", 2000);
                    break;
            }
            
            // Check achievement
            if (stats.powerupsCollected >= 10 && !achievements.powerCollector.earned) {
                achievements.powerCollector.earned = true;
                addAchievement(achievements.powerCollector.text);
            }
        }
        
        // Collision detection
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }
        
        // Handle obstacle hit
        function hitObstacle(obstacle) {
            if (player.powerUp) {
                // Player has power-up, can survive hits
                player.powerUpHits++;
                
                if (player.powerUpType === 'companion' || player.powerUpHits < 3) {
                    // With companion, avoid expense completely
                    if (player.powerUpType === 'companion') {
                        showPopupMessage("החבר שלך עזר לך להימנע מהוצאה!", 1500);
                        stats.obstaclesAvoided++;
                    } else {
                        // Still some cost but reduced
                        const reducedValue = Math.floor(obstacle.value * 0.3);
                        score -= reducedValue;
                        stats.expenses += reducedValue;
                        showPopupMessage(`הוצאת ${reducedValue} ש"ח - פחות בזכות החיזוק!`, 1500);
                    }
                    updateDisplay();
                    return true; // Survived
                }
            }
            
            // No powerup or too many hits - take full damage
            score -= obstacle.value;
            stats.expenses += obstacle.value;
            
            showPopupMessage(`הוצאת ${obstacle.value} ש"ח!`, 1500);
            updateDisplay();
            
            // Check if player is now bankrupt
            if (score < 0) {
                gameOver(`נגמר הכסף! המכשול האחרון: ${obstacle.text}`);
                return false;
            }
            
            return true; // Survived but took damage
        }
        
        // Update game state
        function updateGame() {
            if (!gameRunning || gamePaused) return;
            
            // Update month timer
            currentMonthTimer++;
            
            if (currentMonthTimer >= framesPerMonth) {
                currentMonthTimer = 0;
                currentMonth++;
                stats.monthsPlayed++;
                
                // Add monthly income to score
                score += stats.income;
                
                // Check win condition
                if (score >= 100000) {
                    winGame();
                    return;
                }
                
                // Update display
                updateDisplay();
                
                // Maybe show job offer (15% chance each month)
                if (Math.random() < 0.15) {
                    showJobOffer();
                }
                
                // Create monthly powerups
                const monthlyTypes = ['money', 'earlyRise', 'earlySleep', 'healthyFood', 'exercise'];
                monthlyTypes.forEach(type => {
                    // Schedule powerups throughout the month
                    setTimeout(() => {
                        createCustomPowerup(type);
                    }, getRandomInt(2, monthDuration * 0.8) * 1000);
                });
                
                // Every 2 months, create a companion powerup
                if (currentMonth % 2 === 0) {
                    setTimeout(() => {
                        createCompanion();
                    }, getRandomInt(5, monthDuration * 0.8) * 1000);
                }
                
                // First month achievement
                if (currentMonth === 1 && !achievements.firstMonth.earned) {
                    achievements.firstMonth.earned = true;
                    addAchievement(achievements.firstMonth.text);
                }
                
                // Check savings achievement
                if (score >= 50000 && !achievements.saveHero.earned) {
                    achievements.saveHero.earned = true;
                    addAchievement(achievements.saveHero.text);
                }
            }
            
            // Update player
            if (player.jumping) {
                player.jumpVelocity += player.gravity;
                player.y += player.jumpVelocity;
                
                if (player.y >= ground.y - player.height) {
                    player.y = ground.y - player.height;
                    player.jumping = false;
                    player.jumpVelocity = 0;
                }
            }
            
            // Update powerup status
            if (player.powerUp) {
                player.powerUpTime--;
                
                // Update power meter
                const powerFill = document.getElementById('power-meter-fill');
                const powerPercentage = (player.powerUpTime / maxPowerUpTime) * 100;
                powerFill.style.width = `${Math.min(100, powerPercentage)}%`;
                
                if (player.powerUpTime <= 0) {
                    player.powerUp = false;
                    player.powerUpHits = 0;
                    player.companion = false;
                    document.getElementById('power-meter').style.display = 'none';
                    showPopupMessage("החיזוק נגמר!", 1500);
                }
            }
            
            // Update obstacles
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                obstacle.x -= obstacle.speed;
                
                // Check for collision
                if (checkCollision(player, obstacle)) {
                    const survived = hitObstacle(obstacle);
                    obstacles.splice(i, 1);
                    
                    if (!survived) return; // Game over
                } else if (obstacle.x + obstacle.width < player.x && !obstacle.passed) {
                    // Player successfully avoided the obstacle
                    obstacle.passed = true;
                    stats.obstaclesAvoided++;
                    
                    // Check obstacle ninja achievement
                    if (stats.obstaclesAvoided >= 20 && !achievements.obstacleNinja.earned) {
                        achievements.obstacleNinja.earned = true;
                        addAchievement(achievements.obstacleNinja.text);
                    }
                }
                
                // Remove if off-screen
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1);
                }
            }
            
            // Update powerups
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                powerup.x -= powerup.speed;
                
                // Check for collision
                if (checkCollision(player, powerup)) {
                    // Apply powerup effect
                    applyPowerup(powerup);
                    powerups.splice(i, 1);
                }
                
                // Remove if off-screen
                if (powerup.x + powerup.width < 0) {
                    powerups.splice(i, 1);
                }
            }
            // Maybe create a new obstacle (0.5% chance per frame - adjusted for better gameplay)
            if (Math.random() < 0.005) {
                // Ensure there's enough distance from the last obstacle
                let canCreateObstacle = true;
                
                for (let i = 0; i < obstacles.length; i++) {
                    if (obstacles[i].x > canvas.width - 250) {
                        canCreateObstacle = false;
                        break;
                    }
                }
                
                if (canCreateObstacle) {
                    createObstacle();
                }
            }
            
            // Maybe create a new powerup (0.2% chance per frame)
            if (Math.random() < 0.002) {
                // Make sure powerups are spaced out
                let canCreatePowerup = true;
                
                for (let i = 0; i < powerups.length; i++) {
                    if (powerups[i].x > canvas.width - 300) {
                        canCreatePowerup = false;
                        break;
                    }
                }
                
                if (canCreatePowerup) {
                    createPowerup();
                }
            }
            
            // Process any pending obstacles
            if (pendingObstacles.length > 0 && gameRunning) {
                const now = Date.now();
                
                for (let i = pendingObstacles.length - 1; i >= 0; i--) {
                    if (now >= pendingObstacles[i].time) {
                        createObstacle();
                        pendingObstacles.splice(i, 1);
                    }
                }
            }
            
            // Render game
            renderGame();
            
            // Update game message time
            if (gameMessageTime > 0) {
                gameMessageTime--;
                if (gameMessageTime <= 0) {
                    gameMessage = '';
                }
            }
        }
        
        // Create a specific type of powerup
        function createCustomPowerup(type) {
            let text = '';
            let width = 40;
            let height = 40;
            let value = 1000;
            
            switch(type) {
                case 'money':
                    text = "בונוס כספי";
                    value = getRandomInt(1000, 3000);
                    break;
                case 'earlyRise':
                    text = "קימה מוקדם";
                    break;
                case 'earlySleep':
                    text = "שינה מוקדמת";
                    break;
                case 'healthyFood':
                    text = "אוכל בריא";
                    break;
                case 'exercise':
                    text = "אימון יומי";
                    break;
            }
            
            const powerup = {
                x: canvas.width,
                y: getRandomInt(ground.y - 150, ground.y - 60),
                width: width,
                height: height,
                type: type,
                speed: 5,
                text: text,
                value: value
            };
            
            powerups.push(powerup);
        }
        
        // Render game
        function renderGame() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sky (gradient for nicer look)
            const skyGradient = ctx.createLinearGradient(0, 0, 0, ground.y);
            skyGradient.addColorStop(0, "#1e88e5");
            skyGradient.addColorStop(1, "#90caf9");
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw clouds
            drawClouds();
            
            // Draw ground
            const groundGradient = ctx.createLinearGradient(0, ground.y, 0, canvas.height);
            groundGradient.addColorStop(0, "#8D6E63");
            groundGradient.addColorStop(0.2, "#A1887F");
            groundGradient.addColorStop(1, "#6D4C41");
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, ground.y, ground.width, ground.height);
            
            // Draw grass
            ctx.fillStyle = "#43A047";
            ctx.fillRect(0, ground.y, ground.width, 10);
            
            // Draw player
            ctx.fillStyle = "#000000";
            // Head
            ctx.beginPath();
            ctx.arc(player.x + player.width/2, player.y + player.width/2, player.width/2, 0, Math.PI * 2);
            ctx.fill();
            
            // Body
            ctx.fillRect(player.x + player.width/4, player.y + player.width, player.width/2, player.height - player.width);
            
            // Arms
            ctx.fillRect(player.x - 5, player.y + player.width + 5, player.width/4, player.height/3);
            ctx.fillRect(player.x + player.width - player.width/4 + 5, player.y + player.width + 5, player.width/4, player.height/3);
            
            // Legs
            ctx.fillRect(player.x + player.width/4, player.y + player.height - player.height/3, player.width/5, player.height/3);
            ctx.fillRect(player.x + player.width - player.width/5 - player.width/4, player.y + player.height - player.height/3, player.width/5, player.height/3);
            
            // Power-up effect
            if (player.powerUp) {
                let glowColor;
                
                switch(player.powerUpType) {
                    case 'earlyRise':
                        glowColor = "#FFC107"; // Amber
                        break;
                    case 'earlySleep':
                        glowColor = "#7E57C2"; // Deep Purple
                        break;
                    case 'healthyFood':
                        glowColor = "#4CAF50"; // Green
                        break;
                    case 'exercise':
                        glowColor = "#F44336"; // Red
                        break;
                    case 'companion':
                        glowColor = "#2196F3"; // Blue
                        break;
                    default:
                        glowColor = "#FFEB3B"; // Yellow
                }
                
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(player.x + player.width/2, player.y + player.height/2, player.width*0.8, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw companion if active
            if (player.companion && player.powerUp) {
                // Draw companion
                ctx.fillStyle = "#2196F3"; // Blue
                
                // Head
                ctx.beginPath();
                ctx.arc(player.x - 40, player.y + player.width/2, player.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // Body
                ctx.fillRect(player.x - 40 - player.width/4, player.y + player.width, player.width/2, player.height - player.width);
                
                // Draw speech bubble
                const bubbleWidth = 100;
                const bubbleHeight = 30;
                const bubbleX = player.x - 90;
                const bubbleY = player.y - 40;
                
                // Draw bubble background
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                ctx.strokeStyle = "#000000";
                ctx.strokeRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                
                // Draw text
                ctx.fillStyle = "#000000";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText("אני איתך!", bubbleX + bubbleWidth/2, bubbleY + bubbleHeight/2 + 4);
                ctx.textAlign = "start";
            }
            
            // Draw obstacles
            obstacles.forEach(obstacle => {
                switch(obstacle.type) {
                    case 'person':
                        // Draw person
                        ctx.fillStyle = "#3F51B5"; // Indigo
                        
                        // Head
                        ctx.beginPath();
                        ctx.arc(obstacle.x + obstacle.width/2, obstacle.y + obstacle.width/2, obstacle.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Body
                        ctx.fillRect(obstacle.x + obstacle.width/4, obstacle.y + obstacle.width, obstacle.width/2, obstacle.height - obstacle.width);
                        
                        // Arms
                        ctx.fillRect(obstacle.x - 5, obstacle.y + obstacle.width + 5, obstacle.width/4, obstacle.height/3);
                        ctx.fillRect(obstacle.x + obstacle.width - obstacle.width/4 + 5, obstacle.y + obstacle.width + 5, obstacle.width/4, obstacle.height/3);
                        
                        // Legs
                        ctx.fillRect(obstacle.x + obstacle.width/4, obstacle.y + obstacle.height - obstacle.height/3, obstacle.width/5, obstacle.height/3);
                        ctx.fillRect(obstacle.x + obstacle.width - obstacle.width/5 - obstacle.width/4, obstacle.y + obstacle.height - obstacle.height/3, obstacle.width/5, obstacle.height/3);
                        break;
                        
                    case 'ad':
                        // Draw ad
                        ctx.fillStyle = "#E91E63"; // Pink
                        ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                        
                        // Draw ad icon
                        ctx.fillStyle = "#FFFFFF";
                        ctx.font = "20px Arial";
                        ctx.textAlign = "center";
                        ctx.fillText("$", obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2 + 7);
                        ctx.textAlign = "start";
                        break;
                        
                    case 'food':
                        // Draw food item
                        ctx.fillStyle = "#FF9800"; // Orange
                        ctx.beginPath();
                        ctx.arc(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2, obstacle.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Add some details to make it look like food
                        ctx.strokeStyle = "#FFFFFF";
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(obstacle.x + 10, obstacle.y + obstacle.height/2);
                        ctx.lineTo(obstacle.x + obstacle.width - 10, obstacle.y + obstacle.height/2);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(obstacle.x + obstacle.width/2, obstacle.y + 10);
                        ctx.lineTo(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height - 10);
                        ctx.stroke();
                        break;
                        
                    default:
                        // Default obstacle
                        ctx.fillStyle = "#9E9E9E"; // Grey
                        ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                        break;
                }
                
                // Draw speech bubble if there is text
                if (obstacle.text && obstacle.type !== 'default') {
                    const bubbleWidth = 120;
                    const bubbleHeight = 40;
                    const bubbleX = obstacle.x + (obstacle.width - bubbleWidth) / 2;
                    const bubbleY = obstacle.y - bubbleHeight - 10;
                    
                    // Draw bubble background
                    ctx.fillStyle = "#FFFFFF";
                    ctx.fillRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                    ctx.strokeStyle = "#000000";
                    ctx.strokeRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                    
                    // Draw text
                    ctx.fillStyle = "#000000";
                    ctx.font = "12px Arial";
                    ctx.textAlign = "center";
                    
                    // Handle text wrapping for longer text
                    if (obstacle.text.length > 15) {
                        const words = obstacle.text.split(' ');
                        let line = '';
                        let y = bubbleY + 15;
                        
                        for (let i = 0; i < words.length; i++) {
                            const testLine = line + words[i] + ' ';
                            
                            if (i === words.length - 1 || testLine.length > 15) {
                                ctx.fillText(line, bubbleX + bubbleWidth/2, y);
                                line = words[i] + ' ';
                                y += 15;
                            } else {
                                line = testLine;
                            }
                        }
                        
                        if (line.length > 0) {
                            ctx.fillText(line, bubbleX + bubbleWidth/2, y);
                        }
                    } else {
                        ctx.fillText(obstacle.text, bubbleX + bubbleWidth/2, bubbleY + bubbleHeight/2 + 4);
                    }
                    
                    ctx.textAlign = "start";
                }
            });
            
            // Draw powerups
            powerups.forEach(powerup => {
                let fillColor;
                
                switch(powerup.type) {
                    case 'money':
                        fillColor = "#FFD700"; // Gold
                        break;
                    case 'earlyRise':
                        fillColor = "#FFC107"; // Amber
                        break;
                    case 'earlySleep':
                        fillColor = "#7E57C2"; // Deep Purple
                        break;
                    case 'healthyFood':
                        fillColor = "#4CAF50"; // Green
                        break;
                    case 'exercise':
                        fillColor = "#F44336"; // Red
                        break;
                    case 'companion':
                        fillColor = "#2196F3"; // Blue
                        break;
                    default:
                        fillColor = "#FFEB3B"; // Yellow
                }
                
                // Draw the powerup with different shapes based on type
                if (powerup.type === 'money') {
                    // Draw coin for money
                    ctx.fillStyle = fillColor;
                    ctx.beginPath();
                    ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/2, powerup.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Dollar sign
                    ctx.fillStyle = "#FFFFFF";
                    ctx.font = "20px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText("₪", powerup.x + powerup.width/2, powerup.y + powerup.height/2 + 7);
                    ctx.textAlign = "start";
                } else if (powerup.type === 'companion') {
                    // Draw friendly character
                    ctx.fillStyle = fillColor;
                    
                    // Head
                    ctx.beginPath();
                    ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/3, powerup.width/2.5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Body - heart shape
                    ctx.beginPath();
                    ctx.moveTo(powerup.x + powerup.width/2, powerup.y + powerup.height);
                    ctx.bezierCurveTo(
                        powerup.x + powerup.width, powerup.y + powerup.height * 0.6,
                        powerup.x + powerup.width, powerup.y + powerup.height * 0.4,
                        powerup.x + powerup.width/2, powerup.y + powerup.height * 0.5
                    );
                    ctx.bezierCurveTo(
                        powerup.x, powerup.y + powerup.height * 0.4,
                        powerup.x, powerup.y + powerup.height * 0.6,
                        powerup.x + powerup.width/2, powerup.y + powerup.height
                    );
                    ctx.fill();
                } else {
                    // Draw other powerups
                    ctx.fillStyle = fillColor;
                    
                    // Different shapes for different powerups
                    if (powerup.type === 'earlyRise') {
                        // Sun shape for early rise
                        const centerX = powerup.x + powerup.width/2;
                        const centerY = powerup.y + powerup.height/2;
                        const radius = powerup.width/2.5;
                        
                        // Sun circle
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Sun rays
                        ctx.strokeStyle = fillColor;
                        ctx.lineWidth = 3;
                        for (let i = 0; i < 8; i++) {
                            const angle = i * Math.PI / 4;
                            const rayLength = radius * 0.7;
                            
                            ctx.beginPath();
                            ctx.moveTo(
                                centerX + Math.cos(angle) * radius,
                                centerY + Math.sin(angle) * radius
                            );
                            ctx.lineTo(
                                centerX + Math.cos(angle) * (radius + rayLength),
                                centerY + Math.sin(angle) * (radius + rayLength)
                            );
                            ctx.stroke();
                        }
                    } else if (powerup.type === 'earlySleep') {
                        // Moon shape for early sleep
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/2, powerup.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Inner cut to make crescent
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width/2 + powerup.width/4, powerup.y + powerup.height/2, powerup.width/2.2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalCompositeOperation = 'source-over';
                    } else if (powerup.type === 'healthyFood') {
                        // Apple shape for healthy food
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/2 + powerup.height/10, powerup.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Stem
                        ctx.fillStyle = "#8D6E63";
                        ctx.fillRect(powerup.x + powerup.width/2 - 2, powerup.y + powerup.height/10, 4, 10);
                        
                        // Leaf
                        ctx.fillStyle = "#81C784";
                        ctx.beginPath();
                        ctx.ellipse(powerup.x + powerup.width/2 + 10, powerup.y + powerup.height/5, 8, 5, Math.PI/4, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (powerup.type === 'exercise') {
                        // Dumbbell for exercise
                        ctx.fillStyle = "#78909C";
                        
                        // Left weight
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width * 0.2, powerup.y + powerup.height/2, powerup.width * 0.15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Right weight
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width * 0.8, powerup.y + powerup.height/2, powerup.width * 0.15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Handle
                        ctx.fillRect(powerup.x + powerup.width * 0.2, powerup.y + powerup.height/2 - 5, powerup.width * 0.6, 10);
                    } else {
                        // Default star shape for other powerups
                        const cx = powerup.x + powerup.width/2;
                        const cy = powerup.y + powerup.height/2;
                        const spikes = 5;
                        const outerRadius = powerup.width/2;
                        const innerRadius = powerup.width/4;
                        
                        ctx.beginPath();
                        let rot = Math.PI / 2 * 3;
                        let x = cx;
                        let y = cy;
                        const step = Math.PI / spikes;
                        
                        ctx.moveTo(cx, cy - outerRadius);
                        for (let i = 0; i < spikes; i++) {
                            x = cx + Math.cos(rot) * outerRadius;
                            y = cy + Math.sin(rot) * outerRadius;
                            ctx.lineTo(x, y);
                            rot += step;
                            
                            x = cx + Math.cos(rot) * innerRadius;
                            y = cy + Math.sin(rot) * innerRadius;
                            ctx.lineTo(x, y);
                            rot += step;
                        }
                        ctx.lineTo(cx, cy - outerRadius);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
                
                // Draw text bubble
                const bubbleWidth = 120;
                const bubbleHeight = 30;
                const bubbleX = powerup.x + (powerup.width - bubbleWidth) / 2;
                const bubbleY = powerup.y - bubbleHeight - 10;
                
                // Draw bubble background
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                ctx.strokeStyle = "#000000";
                ctx.strokeRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                
                // Draw text
                ctx.fillStyle = "#000000";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText(powerup.text, bubbleX + bubbleWidth/2, bubbleY + bubbleHeight/2 + 4);
                ctx.textAlign = "start";
            });
            
            // Draw month progress bar
            const progressWidth = 300;
            const progressHeight = 10;
            const progressX = (canvas.width - progressWidth) / 2;
            const progressY = 40;
            
            // Background
            ctx.fillStyle = "#E0E0E0";
            ctx.fillRect(progressX, progressY, progressWidth, progressHeight);
            
            // Progress
            const progress = currentMonthTimer / framesPerMonth;
            ctx.fillStyle = "#4CAF50";
            ctx.fillRect(progressX, progressY, progressWidth * progress, progressHeight);
            
            // Border
            ctx.strokeStyle = "#000000";
            ctx.strokeRect(progressX, progressY, progressWidth, progressHeight);
            
            // Draw game messages if any
            if (gameMessage && gameMessageTime > 0) {
                const alpha = Math.min(1, gameMessageTime / 100);
                ctx.globalAlpha = alpha;
                ctx.fillStyle = "#000000";
                ctx.font = "24px Arial";
                ctx.textAlign = "center";
                ctx.fillText(gameMessage, canvas.width/2, canvas.height/2);
                ctx.textAlign = "start";
                ctx.globalAlpha = 1.0;
            }
        }
        
        // Draw decorative clouds
        function drawClouds() {
            ctx.fillStyle = "#FFFFFF";
            
            // Create cloud positions based on time
            const time = Date.now() / 10000;
            
            // Draw 3-5 clouds at different positions
            for (let i = 0; i < 5; i++) {
                const x = ((i * 300) + time * 30) % canvas.width;
                const y = 50 + i * 20;
                const scale = 0.5 + (i % 3) * 0.2;
                
                // Draw cloud shape
                drawCloud(x, y, scale);
            }
        }
        
        // Helper to draw a single cloud
        function drawCloud(x, y, scale) {
            const radiusX = 30 * scale;
            const radiusY = 20 * scale;
            
            ctx.beginPath();
            ctx.arc(x, y, radiusX, 0, Math.PI * 2);
            ctx.arc(x + radiusX, y - radiusY, radiusX, 0, Math.PI * 2);
            ctx.arc(x + radiusX * 2, y, radiusX, 0, Math.PI * 2);
            ctx.arc(x + radiusX, y + radiusY, radiusX, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Add achievement notification
        function addAchievement(text) {
            const achievementsDiv = document.getElementById('achievements');
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.textContent = text;
            achievementsDiv.appendChild(achievement);
            
            // Show achievements panel
            achievementsDiv.style.display = 'block';
            
            // Display popup message
            showPopupMessage(`הישג חדש: ${text}!`, 3000);
            
            // Add some bonus points
            score += 1000;
            updateDisplay();
        }
        
        // Update display
        function updateDisplay() {
            document.getElementById('score-display').textContent = `חיסכון: ${score.toLocaleString()} ש"ח`;
            document.getElementById('date-display').textContent = monthNames[currentMonth];
            
            // Update monthly stats
            document.getElementById('expenses').textContent = stats.expenses.toLocaleString();
            document.getElementById('income').textContent = stats.income.toLocaleString();
            document.getElementById('monthly-stats').style.display = 'block';
        }
        
        // Show job offer
        function showJobOffer() {
            gamePaused = true;
            jobOfferStage = 0;
            document.getElementById('job-offer').style.display = 'block';
        }
        
        // Show job offer followup
        function showJobOfferFollowup() {
            document.getElementById('job-offer').style.display = 'none';
            document.getElementById('followup-text').textContent = jobOfferTexts[jobOfferStage];
            document.getElementById('job-offer-followup').style.display = 'block';
        }
        
        // Game over
        function gameOver(reason) {
            gameRunning = false;
            document.getElementById('game-over-reason').textContent = reason;
            document.getElementById('final-score').textContent = score.toLocaleString();
            
            // Update game stats
            document.getElementById('months-played').textContent = stats.monthsPlayed;
            document.getElementById('powerups-collected').textContent = stats.powerupsCollected;
            document.getElementById('obstacles-avoided').textContent = stats.obstaclesAvoided;
            
            document.getElementById('game-over').style.display = 'block';
        }
        
        // Win game
        function winGame() {
            gameRunning = false;
            
            // Update win stats
            document.getElementById('win-months').textContent = stats.monthsPlayed;
            document.getElementById('win-powerups').textContent = stats.powerupsCollected;
            document.getElementById('win-obstacles').textContent = stats.obstaclesAvoided;
            
            document.getElementById('win-screen').style.display = 'block';
        }
        
        // Reset game
        function resetGame() {
            gameRunning = true;
            gamePaused = false;
            score = 0;
            currentMonth = 0;
            currentMonthTimer = 0;
            obstacles = [];
            powerups = [];
            pendingObstacles = [];
            
            // Reset stats
            stats = {
                monthsPlayed: 0,
                powerupsCollected: 0,
                obstaclesAvoided: 0,
                expenses: 0,
                income: 5000
            };
            
            // Reset achievements
            achievements = {
                firstMonth: { earned: false, text: "הישרדות חודש ראשון" },
                saveHero: { earned: false, text: "חסכת 50,000 ש\"ח" },
                powerCollector: { earned: false, text: "אספת 10 חיזוקים" },
                obstacleNinja: { earned: false, text: "התחמקת מ-20 מכשולים" }
            };
            
            // Reset player
            player.jumping = false;
            player.jumpVelocity = 0;
            player.powerUp = false;
            player.powerUpTime = 0;
            player.powerUpHits = 0;
            player.companion = false;
            
            // Adjust player size based on screen dimensions
            let scaleFactor = Math.min(window.innerWidth, window.innerHeight) / 500;
            scaleFactor = Math.max(0.5, Math.min(1.5, scaleFactor)); // Limit between 0.5 and 1.5
            player.width = 50 * scaleFactor;
            player.height = 80 * scaleFactor;
            
            // Update player position after size change
            player.y = ground.y - player.height;
            
            // Reset displays
            updateDisplay();
            
            // Clear achievements
            document.getElementById('achievements').innerHTML = '';
            document.getElementById('achievements').style.display = 'none';
            
            // Hide power meter
            document.getElementById('power-meter').style.display = 'none';
            
            // Hide all dialogs
            document.getElementById('job-offer').style.display = 'none';
            document.getElementById('job-offer-followup').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('tutorial-message').style.display = 'none';
        }
        // Jump function
        function jump() {
            if (!player.jumping) {
                player.jumping = true;
                player.jumpVelocity = -player.jumpPower;
                
                // Play jump sound
                try {
                    const jumpSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU92T18=');
                    jumpSound.volume = 0.2;
                    jumpSound.play().catch(e => console.log('Audio play failed:', e));
                } catch (e) {
                    console.log('Audio creation failed:', e);
                }
            }
        }
        
        // Handle window resize
        function handleResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            ground.y = canvas.height * 0.8;
            ground.width = canvas.width;
            ground.height = canvas.height * 0.2;
            
            // Adjust player size and position based on screen dimensions
            let scaleFactor = Math.min(window.innerWidth, window.innerHeight) / 500;
            scaleFactor = Math.max(0.5, Math.min(1.5, scaleFactor)); // Limit between 0.5 and 1.5
            
            player.width = 50 * scaleFactor;
            player.height = 80 * scaleFactor;
            player.y = ground.y - player.height;
            
            // Adjust jump power for screen size
            player.jumpPower = 15 * scaleFactor;
        }
        
        // Start game
        function startGame() {
            // Initialize the game
            resetGame();
            
            // Handle resize event
            window.removeEventListener('resize', handleResize);
            window.addEventListener('resize', handleResize);
            handleResize();
            
            // Show tutorial initially
            tutorialShown = true;
            document.getElementById('tutorial-message').style.display = 'block';
            
            // Game loop - run at 60fps
            const gameLoop = setInterval(() => {
                if (gameRunning) {
                    updateGame();
                }
            }, frameTime);
        }
        
        // Event listeners
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                if (tutorialShown) {
                    tutorialShown = false;
                    document.getElementById('tutorial-message').style.display = 'none';
                    return;
                }
                
                if (gameRunning && !gamePaused) {
                    jump();
                }
            }
        });
        
        // Canvas click events
        canvas.addEventListener('click', function() {
            if (tutorialShown) {
                tutorialShown = false;
                document.getElementById('tutorial-message').style.display = 'none';
                return;
            }
            
            if (gameRunning && !gamePaused) {
                jump();
            }
        });
        
        // Touch events for mobile
        canvas.addEventListener('touchstart', function(event) {
            event.preventDefault();
            
            if (tutorialShown) {
                tutorialShown = false;
                document.getElementById('tutorial-message').style.display = 'none';
                return;
            }
            
            if (gameRunning && !gamePaused) {
                jump();
            }
        });
        
        // Start button click
        document.getElementById('start-btn').addEventListener('click', function() {
            tutorialShown = false;
            document.getElementById('tutorial-message').style.display = 'none';
        });
        
        // Job offer buttons
        document.getElementById('yes-btn').addEventListener('click', function() {
            gameOver("החלפת עבודה! איבדת את היציבות הכלכלית שלך.");
        });
        
        document.getElementById('no-btn').addEventListener('click', function() {
            showJobOfferFollowup();
        });
        
        document.getElementById('followup-yes-btn').addEventListener('click', function() {
            gameOver("החלפת עבודה! איבדת את היציבות הכלכלית שלך.");
        });
        
        document.getElementById('followup-no-btn').addEventListener('click', function() {
            jobOfferStage++;
            if (jobOfferStage < jobOfferTexts.length) {
                document.getElementById('followup-text').textContent = jobOfferTexts[jobOfferStage];
            } else {
                document.getElementById('job-offer-followup').style.display = 'none';
                gamePaused = false;
                
                // Reward player for resisting temptation
                score += 1000;
                showPopupMessage("קיבלת 1,000 ש\"ח בונוס על ההתמדה!", 2000);
                updateDisplay();
            }
        });
        
        // Game over buttons
        document.getElementById('restart-btn').addEventListener('click', function() {
            resetGame();
        });
        
        document.getElementById('play-again-btn').addEventListener('click', function() {
            resetGame();
        });
        
        // Helper function to schedule obstacles
        function scheduleObstacle(delayMs) {
            pendingObstacles.push({
                time: Date.now() + delayMs
            });
        }
        
        // Mobile-specific optimizations
        function optimizeForMobile() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Reduce visual effects for better performance
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 768px) {
                        #game-canvas {
                            image-rendering: optimizeSpeed;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Load game assets
        function preloadAssets() {
            // No external assets needed in this version
            return Promise.resolve();
        }
        
        // Initialize the game when the page loads
        window.onload = function() {
            optimizeForMobile();
            preloadAssets().then(() => {
                startGame();
            }).catch(error => {
                console.error('Failed to load game assets:', error);
                // Start anyway
                startGame();
            });
        };
    </script>
</body>
</html>
