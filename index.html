<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>משחק החיסכון - לימוד למשמעת פיננסית</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #f0f0f0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }
        #game-canvas {
            position: absolute;
            top: 0;
            left: 0;
            background-color: #87CEEB;
            touch-action: none;
        }
        .game-display {
            position: absolute;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        #score-display {
            top: 10px;
            right: 10px;
        }
        #date-display {
            top: 10px;
            left: 10px;
        }
        #tutorial-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            text-align: center;
            z-index: 100;
            max-width: 80%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .dialog-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 80%;
            max-width: 400px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .dialog-box h3 {
            margin-top: 0;
            color: #2a6496;
        }
        .dialog-box button {
            margin: 5px;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        .dialog-box button:hover {
            background-color: #45a049;
        }
        .dialog-box button.no-btn {
            background-color: #f44336;
        }
        .dialog-box button.no-btn:hover {
            background-color: #d32f2f;
        }
        #obstacle-dialog {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.95);
            border: 3px solid #ff5722;
            border-radius: 10px;
            padding: 15px 25px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 300px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        #obstacle-dialog h3 {
            margin-top: 0;
            color: #d32f2f;
        }
        #obstacle-dialog p {
            font-size: 18px;
            margin: 10px 0;
        }
        #obstacle-dialog button {
            margin: 5px;
            padding: 8px 16px;
            font-size: 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        #ignore-btn {
            background-color: #4CAF50;
            color: white;
        }
        #accept-btn {
            background-color: #ff9800;
            color: white;
        }
        #ignore-btn:hover {
            background-color: #388E3C;
        }
        #accept-btn:hover {
            background-color: #F57C00;
        }
        #game-over {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.85);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 80%;
            max-width: 450px;
        }
        #game-over button,
        #win-screen button {
            margin-top: 20px;
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #game-over button:hover,
        #win-screen button:hover {
            background-color: #45a049;
        }
        #win-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(25, 118, 210, 0.9);
            color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            z-index: 100;
            display: none;
            width: 80%;
            max-width: 450px;
        }
        .popup-message {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border-radius: 20px;
            font-size: 16px;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 20;
        }
        .power-meter {
            position: absolute;
            bottom: 20px;
            left: 20px;
            width: 200px;
            height: 15px;
            background-color: #ccc;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        .power-meter-fill {
            height: 100%;
            background-color: #4CAF50;
            width: 0%;
            transition: width 0.1s linear;
        }
        .status-effect {
            position: absolute;
            bottom: 50px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 14px;
            display: none;
        }
        #status-negative {
            background-color: rgba(244, 67, 54, 0.8);
        }
        #status-weight {
            background-color: rgba(255, 152, 0, 0.8);
            left: 150px;
        }
        #speed-indicator {
            position: absolute;
            bottom: 20px;
            right: 20px;
            padding: 10px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 5px;
            font-size: 14px;
        }
        #movement-instruction {
            position: absolute;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.6);
            color: white;
            border-radius: 5px;
            font-size: 16px;
            display: none;
        }
        @media (max-width: 600px) {
            .game-display {
                font-size: 14px;
                padding: 8px;
            }
            .dialog-box {
                width: 95%;
                max-width: 350px;
                padding: 15px;
            }
            .dialog-box h3 {
                font-size: 16px;
            }
            .dialog-box button {
                padding: 8px 16px;
                font-size: 14px;
            }
            #tutorial-message {
                font-size: 14px;
                max-width: 95%;
            }
            .power-meter {
                width: 150px;
                height: 12px;
            }
            #obstacle-dialog {
                width: 250px;
                padding: 10px 15px;
            }
            #obstacle-dialog p {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        <div id="score-display" class="game-display">חיסכון: 0 ש"ח</div>
        <div id="date-display" class="game-display">מרץ 2025</div>
        <div id="monthly-stats">
            <div>הוצאות: <span id="expenses">0</span> ש"ח</div>
            <div>הכנסות: <span id="income">5,000</span> ש"ח</div>
        </div>
        <div id="achievements"></div>
        <div id="power-meter" class="power-meter">
            <div id="power-meter-fill" class="power-meter-fill"></div>
        </div>
        <div id="popup-message" class="popup-message"></div>
        <div id="status-negative" class="status-effect">השפעה מנטלית: חלש</div>
        <div id="status-weight" class="status-effect">מצב גופני: כבד</div>
        <div id="speed-indicator">מהירות: רגילה</div>
        <div id="movement-instruction">לחץ על המסך לרוץ קדימה</div>
        
        <!-- דיאלוג המכשול המשופר -->
        <div id="obstacle-dialog" class="dialog-box">
            <h3 id="obstacle-title">נתקלת בפרס מיוחד!</h3>
            <p id="obstacle-text">האם תרצה לקבל את ההטבה?</p>
            <button id="ignore-btn">התעלם</button>
            <button id="accept-btn">קבל</button>
        </div>
        
        <div id="tutorial-message">
            <h3>ברוכים הבאים למשחק החיסכון!</h3>
            <p>המטרה שלך היא לצבור 100,000 ש"ח על ידי התמדה בעבודה קבועה.</p>
            <p>לחץ על המסך (או החזק מקש הרווח) כדי לרוץ קדימה. אם לא תלחץ, לא תתקדם בדרך לחיסכון.</p>
            <p>אתה מרוויח 5,000 ש"ח בכל חודש מהעבודה היציבה שלך, אבל היזהר מפיתויים!</p>
            <p>המהירות שבה אתה מתקדם מושפעת ממצב הבריאות הפיזית והמנטלית שלך.</p>
            <p>זכור - חיסכון הוא מרתון, לא ספרינט. זה לוקח זמן ומשמעת.</p>
            <button id="start-btn">התחל לשחק</button>
        </div>
        
        <div id="job-offer" class="dialog-box">
            <h3>הצעת עבודה חדשה!</h3>
            <p>האם אתה רוצה להחליף את העבודה היציבה שלך בעבודה שנשמעת מפתה יותר?</p>
            <button id="yes-btn">כן</button>
            <button id="no-btn" class="no-btn">לא</button>
        </div>
        
        <div id="job-offer-followup" class="dialog-box">
            <h3>אולי תשקול שוב?</h3>
            <p id="followup-text">האם אתה בטוח שאתה לא רוצה להחליף את העבודה שלך?</p>
            <button id="followup-yes-btn">כן</button>
            <button id="followup-no-btn" class="no-btn">לא</button>
        </div>
        
        <div id="game-over">
            <h2>המשחק נגמר!</h2>
            <p id="game-over-reason"></p>
            <p>הגעת לחיסכון של <span id="final-score">0</span> ש"ח</p>
            <div id="game-stats">
                <p>שיחקת <span id="months-played">0</span> חודשים</p>
                <p>אספת <span id="powerups-collected">0</span> חיזוקים</p>
                <p>התמודדת עם <span id="obstacles-avoided">0</span> פיתויים</p>
            </div>
            <p class="lesson">למדת שחיסכון דורש משמעת, סבלנות והתמדה לאורך זמן.</p>
            <button id="restart-btn">התחל מחדש</button>
        </div>
        
        <div id="win-screen">
            <h2>ניצחון!</h2>
            <p>הצלחת להגיע ליעד של 100,000 ש"ח!</p>
            <p>כל הכבוד על ההתמדה, המשמעת העצמית וקבלת ההחלטות הנכונות!</p>
            <div id="win-stats">
                <p>השלמת את המשחק ב-<span id="win-months">0</span> חודשים</p>
                <p>אספת <span id="win-powerups">0</span> חיזוקים</p>
                <p>עמדת בפני <span id="win-obstacles">0</span> פיתויים</p>
            </div>
            <p class="lesson">זכור: חיסכון הוא מסע ארוך שדורש התמדה - בדיוק כמו במשחק הזה!</p>
            <button id="play-again-btn">שחק שוב</button>
        </div>
    </div>
    <script>
        // Canvas and context setup
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // Set canvas to cover the window
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        
        // Game variables
        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let currentMonth = 0;
        let tutorialShown = true;
        let isMoving = false; // שליטה בתנועה
        let moveTimer = null; // לזמן תצוגת ההוראה
        
        // Game statistics
        let stats = {
            monthsPlayed: 0,
            powerupsCollected: 0,
            obstaclesAvoided: 0,
            obstaclesFaced: 0,
            expenses: 0,
            income: 5000,  // Starting monthly income
            mentalHealth: 100, // מצב מנטלי שמשפיע על מהירות התקדמות
            physicalHealth: 100 // מצב גופני שמשפיע על מהירות התקדמות
        };
        
        // Achievements
        let achievements = {
            firstMonth: { earned: false, text: "הישרדות חודש ראשון" },
            saveHero: { earned: false, text: "חסכת 50,000 ש\"ח" },
            powerCollector: { earned: false, text: "אספת 10 חיזוקים" },
            resistanceMaster: { earned: false, text: "עמדת בפני 20 פיתויים" },
            mentalStrength: { earned: false, text: "שמרת על בריאות מנטלית חזקה" }
        };
        
        const totalMonths = 20; // From March 2025 to November 2026
        const monthNames = [
            "מרץ 2025", "אפריל 2025", "מאי 2025", "יוני 2025", "יולי 2025", 
            "אוגוסט 2025", "ספטמבר 2025", "אוקטובר 2025", "נובמבר 2025", "דצמבר 2025",
            "ינואר 2026", "פברואר 2026", "מרץ 2026", "אפריל 2026", "מאי 2026", 
            "יוני 2026", "יולי 2026", "אוגוסט 2026", "ספטמבר 2026", "אוקטובר 2026", "נובמבר 2026"
        ];
        
        // Month duration is increased to make the game longer - 60 seconds per month
        const monthDuration = 60; // 60 seconds per month
        const framesPerSecond = 60;
        const frameTime = 1000 / framesPerSecond;
        const framesPerMonth = monthDuration * framesPerSecond;
        let currentMonthTimer = 0;
        
        // Power-up variables
        const maxPowerUpTime = 300; // 5 seconds at 60fps
        let gameMessage = '';
        let gameMessageTime = 0;
        
        // Player variables
        const player = {
            x: canvas.width * 0.2,
            y: canvas.height * 0.7,
            width: 50,
            height: 80,
            baseSpeed: 5, // מהירות בסיסית
            currentSpeed: 5, // מהירות נוכחית המושפעת ממצב השחקן
            powerUp: false,
            powerUpTime: 0,
            powerUpType: '',
            companion: false,
            weight: 1, // יגדל עם צריכת אוכל לא בריא, ישפיע על מהירות
            mentalStrength: 1 // יקטן עם השפעות מנטליות שליליות, ישפיע על מהירות
        };
        
        // Ground variables
        const ground = {
            y: canvas.height * 0.8,
            width: canvas.width,
            height: canvas.height * 0.2
        };
        
        // Arrays for game objects
        let obstacles = [];
        let powerups = [];
        let pendingObstacles = [];  // For delayed creation
        
        // Obstacle dialog variables
        let currentObstacle = null;
        let lastObstacleTime = 0;
        const minObstacleInterval = 5000; // Minimum time between obstacle dialogs (5 seconds)
        let persuasionStage = 0; // משתנה חדש לשלב השכנוע הנוכחי
        let persuasionTexts = []; // טקסטים לשכנוע ישמרו פר מכשול
        
        // Job offer variables
        let jobOfferStage = 0;
        const jobOfferTexts = [
            "האם אתה בטוח שאתה לא רוצה להחליף את העבודה שלך?",
            "היא באמת שווה ומשלמת יותר!",
            "אפשר להרוויח שם יותר כסף!",
            "היא יותר קלילה ופחות שעות עבודה!"
        ];
        
        // Helper for random number generation
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        // Display popup message
        function showPopupMessage(message, duration = 2000) {
            const popup = document.getElementById('popup-message');
            popup.textContent = message;
            popup.style.opacity = '1';
            
            setTimeout(() => {
                popup.style.opacity = '0';
            }, duration);
        }
        
        // Update player's speed based on mental and physical health
        function updatePlayerCondition() {
            // Calculate weight effect (physical health)
            let weightEffect = 1;
            if (stats.physicalHealth < 80) {
                weightEffect = 0.9;
                document.getElementById('status-weight').style.display = 'block';
                document.getElementById('status-weight').textContent = "מצב גופני: כבד";
            } else if (stats.physicalHealth < 60) {
                weightEffect = 0.7;
                document.getElementById('status-weight').style.display = 'block';
                document.getElementById('status-weight').textContent = "מצב גופני: כבד מאוד";
            } else if (stats.physicalHealth < 40) {
                weightEffect = 0.5;
                document.getElementById('status-weight').style.display = 'block';
                document.getElementById('status-weight').textContent = "מצב גופני: עודף משקל חמור";
            } else {
                document.getElementById('status-weight').style.display = 'none';
            }
            
            // Calculate mental effect
            let mentalEffect = 1;
            if (stats.mentalHealth < 80) {
                mentalEffect = 0.9;
                document.getElementById('status-negative').style.display = 'block';
                document.getElementById('status-negative').textContent = "השפעה מנטלית: חלש";
            } else if (stats.mentalHealth < 60) {
                mentalEffect = 0.7;
                document.getElementById('status-negative').style.display = 'block';
                document.getElementById('status-negative').textContent = "השפעה מנטלית: חלש מאוד";
            } else if (stats.mentalHealth < 40) {
                mentalEffect = 0.5;
                document.getElementById('status-negative').style.display = 'block';
                document.getElementById('status-negative').textContent = "השפעה מנטלית: דיכאון";
            } else {
                document.getElementById('status-negative').style.display = 'none';
            }
            
            // Update player speed
            player.currentSpeed = player.baseSpeed * weightEffect * mentalEffect;
            
            // עדכון מחוון מהירות
            const speedIndicator = document.getElementById('speed-indicator');
            if (player.currentSpeed < player.baseSpeed * 0.6) {
                speedIndicator.textContent = 'מהירות: איטית מאוד';
                speedIndicator.style.backgroundColor = 'rgba(244, 67, 54, 0.8)';
            } else if (player.currentSpeed < player.baseSpeed * 0.8) {
                speedIndicator.textContent = 'מהירות: איטית';
                speedIndicator.style.backgroundColor = 'rgba(255, 152, 0, 0.8)';
            } else if (player.currentSpeed < player.baseSpeed * 0.95) {
                speedIndicator.textContent = 'מהירות: בינונית';
                speedIndicator.style.backgroundColor = 'rgba(255, 193, 7, 0.8)';
            } else {
                speedIndicator.textContent = 'מהירות: רגילה';
                speedIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.6)';
            }
        }
        
        // Create obstacle
        function createObstacle() {
            const types = ['person', 'ad', 'food'];
            const type = types[getRandomInt(0, types.length - 1)];
            
            let obstacle;
            
            if (type === 'person') {
                const negativeComments = [
                    "אתה לא טוב מספיק",
                    "אתה לא תצליח לחסוך",
                    "זה גדול עליך",
                    "אתה לא מספיק חכם",
                    "חיסכון זה לעשירים בלבד",
                    "אף פעם לא תגיע ל-100,000",
                    "למה לחסוך? תהנה מהחיים עכשיו"
                ];
                
                // טקסטים משכנעים עבור אנשים שליליים
                const persuasiveTexts = [
                    // שלב ראשון - הכותרת והטקסט הראשוני יקבעו בנפרד
                    `תראה, כולם סביבך מצליחים יותר ממך. אולי הם צודקים?`, // שלב שני
                    `למה לעבוד כל כך קשה? הרי סטטיסטית רוב האנשים לא מצליחים.`, // שלב שלישי
                    `מה הטעם בחיסכון? תחשוב כמה הנאות אתה מפספס בדרך.` // שלב רביעי
                ];
                
                obstacle = {
                    x: canvas.width,
                    y: ground.y - 80,
                    width: 50,
                    height: 80,
                    type: type,
                    speed: 4 + (currentMonth * 0.1),
                    text: negativeComments[getRandomInt(0, negativeComments.length - 1)],
                    value: getRandomInt(500, 1000), // Cost if hit
                    mentalEffect: getRandomInt(5, 15), // How much it will reduce mental health
                    persuasiveTexts: persuasiveTexts,
                    obstacleTitle: "מחשבה שלילית!",
                    initialText: "אתה מרגיש שחיסכון הוא דבר קשה מדי בשבילך."
                };
            } else if (type === 'ad') {
                const adTexts = [
                    "מבצע מטורף! קנה עכשיו!",
                    "רק היום: הנחה של 70%!",
                    "חליפה חדשה תעזור לך למצוא עבודה",
                    "חופשה מושלמת ב-50% הנחה!",
                    "קורס שיעזור לך להרוויח יותר!",
                    "רק קפה קטן, זה לא יפגע בחיסכון!",
                    "מכונית חדשה - תשלומים נוחים!"
                ];
                
                // טקסטים משכנעים עבור פרסומות
                const persuasiveTexts = [
                    `זו הזדמנות שלא תחזור! אחרי הכל, כולם רוצים זאת!`,
                    `תחשוב כמה זמן רצית את זה. הגיע הזמן לפנק את עצמך!`,
                    `זה לא יפגע בחיסכון שלך, זו השקעה בעתיד.`
                ];
                
                obstacle = {
                    x: canvas.width,
                    y: ground.y - 70,
                    width: 60,
                    height: 70,
                    type: type,
                    speed: 5 + (currentMonth * 0.15),
                    text: adTexts[getRandomInt(0, adTexts.length - 1)],
                    value: getRandomInt(1000, 3000),
                    persuasiveTexts: persuasiveTexts,
                    obstacleTitle: "מבצע מיוחד!",
                    initialText: "מצאת הזדמנות לרכוש משהו שתמיד רצית במחיר אטרקטיבי!"
                };
            } else if (type === 'food') {
                const foodTypes = [
                    "ממתקים וחטיפים",
                    "אוכל מהיר שמן",
                    "משקאות מתוקים",
                    "ארוחות יקרות במסעדות",
                    "הזמנת משלוחים במקום לבשל",
                    "קניות במכולת יקרה"
                ];
                
                // טקסטים משכנעים עבור אוכל
                const persuasiveTexts = [
                    `זה טעים כל כך! אתה ממש צריך את זה עכשיו.`,
                    `מידי פעם מותר לאכול משהו טעים, זה לא יעשה לך כלום.`,
                    `כולם אוכלים את זה, למה שלא תתפנק גם?`
                ];
                
                obstacle = {
                    x: canvas.width,
                    y: ground.y - 60,
                    width: 50,
                    height: 60,
                    type: type,
                    speed: 3 + (currentMonth * 0.1),
                    text: foodTypes[getRandomInt(0, foodTypes.length - 1)],
                    value: getRandomInt(300, 1200),
                    weightEffect: getRandomInt(5, 15), // How much it will reduce physical health
                    persuasiveTexts: persuasiveTexts,
                    obstacleTitle: "פיתוי טעים!",
                    initialText: "נתקלת באוכל טעים ומפתה שקשה לעמוד בפניו."
                };
            }
            
            obstacles.push(obstacle);
        }
        
        // Create powerup
        function createPowerup() {
            const types = ['money', 'earlyRise', 'earlySleep', 'healthyFood', 'exercise'];
            const type = types[getRandomInt(0, types.length - 1)];
            
            let text = '';
            let width = 40;
            let height = 40;
            let value = 1000;
            
            switch(type) {
                case 'money':
                    text = "בונוס כספי";
                    value = getRandomInt(1000, 3000);
                    break;
                case 'earlyRise':
                    text = "קימה מוקדם";
                    break;
                case 'earlySleep':
                    text = "שינה מוקדמת";
                    break;
                case 'healthyFood':
                    text = "אוכל בריא";
                    break;
                case 'exercise':
                    text = "אימון יומי";
                    break;
            }
            
            const powerup = {
                x: canvas.width,
                y: getRandomInt(ground.y - 150, ground.y - 60),
                width: width,
                height: height,
                type: type,
                speed: 4, // Slower speed for longer game
                text: text,
                value: value,
                healthEffect: type === 'healthyFood' || type === 'exercise' ? 10 : 0, // Improve physical health
                mentalEffect: type === 'earlySleep' || type === 'earlyRise' ? 10 : 0 // Improve mental health
            };
            
            powerups.push(powerup);
        }
        
        // Create companion
        function createCompanion() {
            const companion = {
                x: canvas.width,
                y: ground.y - 70,
                width: 40,
                height: 70,
                speed: 4,
                type: 'companion',
                text: "אני ארוץ איתך ביחד!"
            };
            
            powerups.push(companion);
            showPopupMessage("חבר לריצה מתקרב!");
        }
        
        // Apply powerup effect
        function applyPowerup(powerup) {
            stats.powerupsCollected++;
            
            switch(powerup.type) {
                case 'money':
                    score += powerup.value;
                    stats.income += powerup.value;
                    showPopupMessage(`קיבלת ${powerup.value} ש"ח!`, 1500);
                    updateDisplay();
                    break;
                case 'earlyRise':
                case 'earlySleep':
                    player.powerUp = true;
                    player.powerUpTime = maxPowerUpTime;
                    player.powerUpType = powerup.type;
                    document.getElementById('power-meter').style.display = 'block';
                    showPopupMessage(`חיזוק פעיל: ${powerup.text}!`, 1500);
                    
                    // Improve mental health
                    stats.mentalHealth = Math.min(100, stats.mentalHealth + powerup.mentalEffect);
                    updatePlayerCondition();
                    break;
                case 'healthyFood':
                case 'exercise':
                    player.powerUp = true;
                    player.powerUpTime = maxPowerUpTime;
                    player.powerUpType = powerup.type;
                    document.getElementById('power-meter').style.display = 'block';
                    showPopupMessage(`חיזוק פעיל: ${powerup.text}!`, 1500);
                    
                    // Improve physical health
                    stats.physicalHealth = Math.min(100, stats.physicalHealth + powerup.healthEffect);
                    updatePlayerCondition();
                    break;
                case 'companion':
                    player.companion = true;
                    player.powerUp = true;
                    player.powerUpTime = maxPowerUpTime * 2; // Companion lasts longer
                    player.powerUpType = 'companion';
                    document.getElementById('power-meter').style.display = 'block';
                    showPopupMessage("חבר לריצה מצטרף אליך!", 2000);
                    
                    // Companion helps with both mental and physical health
                    stats.mentalHealth = Math.min(100, stats.mentalHealth + 15);
                    stats.physicalHealth = Math.min(100, stats.physicalHealth + 15);
                    updatePlayerCondition();
                    break;
            }
            
            // Check achievement
            if (stats.powerupsCollected >= 10 && !achievements.powerCollector.earned) {
                achievements.powerCollector.earned = true;
                addAchievement(achievements.powerCollector.text);
            }
        }
        
        // Show obstacle dialog with persuasive text
        function showObstacleDialog(obstacle) {
            // Pause the game
            gamePaused = true;
            currentObstacle = obstacle;
            persuasionStage = 0; // איפוס שלב השכנוע
            
            // Set dialog content - שלב ראשוני
            document.getElementById('obstacle-title').textContent = obstacle.obstacleTitle;
            document.getElementById('obstacle-text').textContent = obstacle.initialText;
            
            // Show dialog
            document.getElementById('obstacle-dialog').style.display = 'block';
        }
        
        // Continue to next persuasion stage
        function continuePersuasion() {
            if (!currentObstacle) return;
            
            persuasionStage++;
            
            // Check if we have more persuasive texts
            if (persuasionStage <= currentObstacle.persuasiveTexts.length) {
                // עדכון הטקסט לשלב הנוכחי
                document.getElementById('obstacle-text').textContent = 
                    currentObstacle.persuasiveTexts[persuasionStage - 1];
                
                // במידה וזה השלב האחרון, שנה את הטקסט של כפתור ההתעלמות
                if (persuasionStage === currentObstacle.persuasiveTexts.length) {
                    document.getElementById('ignore-btn').textContent = "אני מתעלם!";
                } else {
                    document.getElementById('ignore-btn').textContent = "התעלם";
                }
            } else {
                // אם אין עוד טקסטים, סגור את הדיאלוג
                hideObstacleDialog();
                stats.obstaclesAvoided++; // הוספת מונה התנגדות
                
                // Small mental boost for fully resisting
                stats.mentalHealth = Math.min(100, stats.mentalHealth + 5);
                updatePlayerCondition();
                
                // Show resistance message
                showPopupMessage("כל הכבוד! עמדת בפני הפיתוי עד הסוף!", 2000);
                
                // Check resistance achievement
                if (stats.obstaclesAvoided >= 20 && !achievements.resistanceMaster.earned) {
                    achievements.resistanceMaster.earned = true;
                    addAchievement(achievements.resistanceMaster.text);
                }
            }
        }
        
        // Handle accepting obstacle
        function acceptObstacle() {
            if (!currentObstacle) return;
            
            // Apply the negative effects
            score -= currentObstacle.value;
            stats.expenses += currentObstacle.value;
            
            // Apply specific effects based on obstacle type
            if (currentObstacle.type === 'person') {
                stats.mentalHealth -= currentObstacle.mentalEffect;
                showPopupMessage(`המנטליות שלך נחלשה! -${currentObstacle.mentalEffect} נקודות מנטליות`, 2000);
            } else if (currentObstacle.type === 'food') {
                stats.physicalHealth -= currentObstacle.weightEffect;
                showPopupMessage(`המשקל שלך עלה! -${currentObstacle.weightEffect} נקודות בריאות`, 2000);
            } else {
                showPopupMessage(`הוצאת ${currentObstacle.value} ש"ח!`, 1500);
            }
            
            // עדכון מונה אינטראקציות עם מכשולים
            stats.obstaclesFaced++;
            
            // Update player condition
            updatePlayerCondition();
            updateDisplay();
            
            // Reset and continue game
            hideObstacleDialog();
            
            // Check if player is now bankrupt
            if (score < 0) {
                gameOver(`נגמר הכסף! הוצאת יותר מדי על ${currentObstacle.text}`);
                return;
            }
            
            // Check if mental or physical health is too low
            if (stats.mentalHealth <= 20) {
                gameOver("המוטיבציה שלך נשברה לגמרי. אין לך כוח להמשיך.");
                return;
            }
            
            if (stats.physicalHealth <= 20) {
                gameOver("הבריאות הפיזית שלך נפגעה מאוד. קשה לך להמשיך.");
                return;
            }
        }
        
        // Hide obstacle dialog and continue game
        function hideObstacleDialog() {
            document.getElementById('obstacle-dialog').style.display = 'none';
            currentObstacle = null;
            gamePaused = false;
            persuasionStage = 0;
            
            // Reset ignore button text
            document.getElementById('ignore-btn').textContent = "התעלם";
        }
        
        // Collision detection
        function checkCollision(obj1, obj2) {
            return obj1.x < obj2.x + obj2.width &&
                   obj1.x + obj1.width > obj2.x &&
                   obj1.y < obj2.y + obj2.height &&
                   obj1.y + obj1.height > obj2.y;
        }
        
        // Handle obstacle hit
        function hitObstacle(obstacle) {
            // See if enough time has passed since last obstacle dialog
            const now = Date.now();
            if (now - lastObstacleTime < minObstacleInterval) {
                // Too soon for another obstacle dialog
                return true;
            }
            
            // Show obstacle dialog
            showObstacleDialog(obstacle);
            lastObstacleTime = now;
            
            return true; // Obstacle is handled (will be removed in the main loop)
        }
        // Update game state
        function updateGame() {
            if (!gameRunning || gamePaused) return;
            
            // Update month timer only if player is moving (pressing screen)
            if (isMoving) {
                // התקדמות במהירות המותאמת למצב השחקן
                currentMonthTimer += player.currentSpeed / player.baseSpeed;
                
                // הוראות תנועה - הצג אחרי 5 שניות של אי תנועה
                if (moveTimer) {
                    clearTimeout(moveTimer);
                    moveTimer = null;
                    document.getElementById('movement-instruction').style.display = 'none';
                }
            } else {
                // הצג הוראות תנועה אם השחקן לא זז למשך מספר שניות
                if (!moveTimer && !tutorialShown) {
                    moveTimer = setTimeout(() => {
                        document.getElementById('movement-instruction').style.display = 'block';
                    }, 5000);
                }
            }
            
            if (currentMonthTimer >= framesPerMonth) {
                currentMonthTimer = 0;
                currentMonth++;
                stats.monthsPlayed++;
                
                // Add monthly income to score
                score += stats.income;
                
                // Slightly recover mental and physical health each month
                stats.mentalHealth = Math.min(100, stats.mentalHealth + 2);
                stats.physicalHealth = Math.min(100, stats.physicalHealth + 2);
                updatePlayerCondition();
                
                // Check win condition
                if (score >= 100000) {
                    winGame();
                    return;
                }
                
                // Update display
                updateDisplay();
                
                // Maybe show job offer (15% chance each month)
                if (Math.random() < 0.15) {
                    showJobOffer();
                }
                
                // Create monthly powerups
                const monthlyTypes = ['money', 'earlyRise', 'earlySleep', 'healthyFood', 'exercise'];
                monthlyTypes.forEach(type => {
                    // Schedule powerups throughout the month
                    setTimeout(() => {
                        createCustomPowerup(type);
                    }, getRandomInt(5, monthDuration * 0.7) * 1000);
                });
                
                // Every 2 months, create a companion powerup
                if (currentMonth % 2 === 0) {
                    setTimeout(() => {
                        createCompanion();
                    }, getRandomInt(10, monthDuration * 0.6) * 1000);
                }
                
                // First month achievement
                if (currentMonth === 1 && !achievements.firstMonth.earned) {
                    achievements.firstMonth.earned = true;
                    addAchievement(achievements.firstMonth.text);
                }
                
                // Check savings achievement
                if (score >= 50000 && !achievements.saveHero.earned) {
                    achievements.saveHero.earned = true;
                    addAchievement(achievements.saveHero.text);
                }
                
                // Check mental strength achievement
                if (stats.mentalHealth >= 90 && currentMonth >= 5 && !achievements.mentalStrength.earned) {
                    achievements.mentalStrength.earned = true;
                    addAchievement(achievements.mentalStrength.text);
                }
            }
            
            // Update powerup status
            if (player.powerUp) {
                player.powerUpTime--;
                
                // Update power meter
                const powerFill = document.getElementById('power-meter-fill');
                const powerPercentage = (player.powerUpTime / maxPowerUpTime) * 100;
                powerFill.style.width = `${Math.min(100, powerPercentage)}%`;
                
                if (player.powerUpTime <= 0) {
                    player.powerUp = false;
                    player.companion = false;
                    document.getElementById('power-meter').style.display = 'none';
                    showPopupMessage("החיזוק נגמר!", 1500);
                }
            }
            
            // Update obstacles
            for (let i = obstacles.length - 1; i >= 0; i--) {
                const obstacle = obstacles[i];
                
                // עדכון מיקום רק אם השחקן זז
                if (isMoving) {
                    obstacle.x -= obstacle.speed;
                }
                
                // Check for collision
                if (checkCollision(player, obstacle)) {
                    const survived = hitObstacle(obstacle);
                    obstacles.splice(i, 1);
                    
                    if (!survived) return; // Game over
                }
                
                // Remove if off-screen
                if (obstacle.x + obstacle.width < 0) {
                    obstacles.splice(i, 1);
                }
            }
            
            // Update powerups
            for (let i = powerups.length - 1; i >= 0; i--) {
                const powerup = powerups[i];
                
                // עדכון מיקום רק אם השחקן זז
                if (isMoving) {
                    powerup.x -= powerup.speed;
                }
                
                // Check for collision
                if (checkCollision(player, powerup)) {
                    // Apply powerup effect
                    applyPowerup(powerup);
                    powerups.splice(i, 1);
                }
                
                // Remove if off-screen
                if (powerup.x + powerup.width < 0) {
                    powerups.splice(i, 1);
                }
            }
            
            // Maybe create a new obstacle (0.3% chance per frame - slower for longer game)
            if (Math.random() < 0.003 && isMoving) {
                // Ensure there's enough distance from the last obstacle
                let canCreateObstacle = true;
                
                for (let i = 0; i < obstacles.length; i++) {
                    if (obstacles[i].x > canvas.width - 350) { // More space between obstacles
                        canCreateObstacle = false;
                        break;
                    }
                }
                
                if (canCreateObstacle) {
                    createObstacle();
                }
            }
            
            // Maybe create a new powerup (0.1% chance per frame - fewer powerups)
            if (Math.random() < 0.001 && isMoving) {
                // Make sure powerups are spaced out
                let canCreatePowerup = true;
                
                for (let i = 0; i < powerups.length; i++) {
                    if (powerups[i].x > canvas.width - 400) { // More space between powerups
                        canCreatePowerup = false;
                        break;
                    }
                }
                
                if (canCreatePowerup) {
                    createPowerup();
                }
            }
            
            // Process any pending obstacles
            if (pendingObstacles.length > 0 && gameRunning && isMoving) {
                const now = Date.now();
                
                for (let i = pendingObstacles.length - 1; i >= 0; i--) {
                    if (now >= pendingObstacles[i].time) {
                        createObstacle();
                        pendingObstacles.splice(i, 1);
                    }
                }
            }
            
            // Render game
            renderGame();
            
            // Update game message time
            if (gameMessageTime > 0) {
                gameMessageTime--;
                if (gameMessageTime <= 0) {
                    gameMessage = '';
                }
            }
        }
        
        // Create a specific type of powerup
        function createCustomPowerup(type) {
            let text = '';
            let width = 40;
            let height = 40;
            let value = 1000;
            let healthEffect = 0;
            let mentalEffect = 0;
            
            switch(type) {
                case 'money':
                    text = "בונוס כספי";
                    value = getRandomInt(1000, 3000);
                    break;
                case 'earlyRise':
                    text = "קימה מוקדם";
                    mentalEffect = 10;
                    break;
                case 'earlySleep':
                    text = "שינה מוקדמת";
                    mentalEffect = 15;
                    break;
                case 'healthyFood':
                    text = "אוכל בריא";
                    healthEffect = 15;
                    break;
                case 'exercise':
                    text = "אימון יומי";
                    healthEffect = 20;
                    break;
            }
            
            const powerup = {
                x: canvas.width,
                y: getRandomInt(ground.y - 150, ground.y - 60),
                width: width,
                height: height,
                type: type,
                speed: 4,
                text: text,
                value: value,
                healthEffect: healthEffect,
                mentalEffect: mentalEffect
            };
            
            powerups.push(powerup);
        }
        
        // Render game
        function renderGame() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw sky (gradient for nicer look)
            const skyGradient = ctx.createLinearGradient(0, 0, 0, ground.y);
            skyGradient.addColorStop(0, "#1e88e5");
            skyGradient.addColorStop(1, "#90caf9");
            ctx.fillStyle = skyGradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw clouds
            drawClouds();
            
            // Draw ground
            const groundGradient = ctx.createLinearGradient(0, ground.y, 0, canvas.height);
            groundGradient.addColorStop(0, "#8D6E63");
            groundGradient.addColorStop(0.2, "#A1887F");
            groundGradient.addColorStop(1, "#6D4C41");
            ctx.fillStyle = groundGradient;
            ctx.fillRect(0, ground.y, ground.width, ground.height);
            
            // Draw "stable job" text on the ground
            ctx.fillStyle = "#FFFFFF";
            ctx.font = "bold 24px Arial";
            ctx.textAlign = "center";
            const text = "עבודה אחת קבועה ויציבה";
            
            // Create pattern with the text repeating across the ground
            const textWidth = ctx.measureText(text).width;
            const repetitions = Math.ceil(canvas.width / (textWidth + 100));
            
            for (let i = 0; i < repetitions; i++) {
                ctx.fillText(text, (textWidth + 100) * i + textWidth/2 + 50, ground.y + 40);
            }
            
            ctx.textAlign = "start";
            
            // Draw grass
            ctx.fillStyle = "#43A047";
            ctx.fillRect(0, ground.y, ground.width, 10);
            
            // Draw player - adjusting size based on physical health
            const healthFactor = stats.physicalHealth / 100;
            const widthAdjustment = 1 + (1 - healthFactor) * 0.5; // Up to 50% wider
            
            // Calculate adjusted dimensions
            const adjustedWidth = player.width * widthAdjustment;
            const playerCenterX = player.x + player.width/2;
            const adjustedX = playerCenterX - adjustedWidth/2;
            
            ctx.fillStyle = "#000000";
            
            // Head
            ctx.beginPath();
            ctx.arc(playerCenterX, player.y + player.width/2, player.width/2 * widthAdjustment, 0, Math.PI * 2);
            ctx.fill();
            
            // Body
            ctx.fillRect(adjustedX + adjustedWidth/4, player.y + player.width, adjustedWidth/2, player.height - player.width);
            
            // Arms
            ctx.fillRect(adjustedX - 5, player.y + player.width + 5, adjustedWidth/4, player.height/3);
            ctx.fillRect(adjustedX + adjustedWidth - adjustedWidth/4 + 5, player.y + player.width + 5, adjustedWidth/4, player.height/3);
            
            // Legs
            ctx.fillRect(adjustedX + adjustedWidth/4, player.y + player.height - player.height/3, adjustedWidth/5, player.height/3);
            ctx.fillRect(adjustedX + adjustedWidth - adjustedWidth/5 - adjustedWidth/4, player.y + player.height - player.height/3, adjustedWidth/5, player.height/3);
            
            // Draw mental state indicator - facial expression based on mental health
            if (stats.mentalHealth < 50) {
                // Sad face
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                
                // Mouth (frown)
                ctx.beginPath();
                ctx.arc(playerCenterX, player.y + player.width/2 + 10, player.width/4, 0.1 * Math.PI, 0.9 * Math.PI, true);
                ctx.stroke();
                
                // Eyes (sad)
                ctx.beginPath();
                ctx.arc(playerCenterX - player.width/5, player.y + player.width/2 - 5, 3, 0, Math.PI * 2);
                ctx.arc(playerCenterX + player.width/5, player.y + player.width/2 - 5, 3, 0, Math.PI * 2);
                ctx.fill();
            } else {
                // Happy face
                ctx.strokeStyle = "#FFFFFF";
                ctx.lineWidth = 2;
                
                // Mouth (smile)
                ctx.beginPath();
                ctx.arc(playerCenterX, player.y + player.width/2 + 5, player.width/4, 0.1 * Math.PI, 0.9 * Math.PI);
                ctx.stroke();
                
                // Eyes (happy)
                ctx.beginPath();
                ctx.arc(playerCenterX - player.width/5, player.y + player.width/2 - 5, 3, 0, Math.PI * 2);
                ctx.arc(playerCenterX + player.width/5, player.y + player.width/2 - 5, 3, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Power-up effect
            if (player.powerUp) {
                let glowColor;
                
                switch(player.powerUpType) {
                    case 'earlyRise':
                        glowColor = "#FFC107"; // Amber
                        break;
                    case 'earlySleep':
                        glowColor = "#7E57C2"; // Deep Purple
                        break;
                    case 'healthyFood':
                        glowColor = "#4CAF50"; // Green
                        break;
                    case 'exercise':
                        glowColor = "#F44336"; // Red
                        break;
                    case 'companion':
                        glowColor = "#2196F3"; // Blue
                        break;
                    default:
                        glowColor = "#FFEB3B"; // Yellow
                }
                
                ctx.strokeStyle = glowColor;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(playerCenterX, player.y + player.height/2, player.width*0.8, 0, Math.PI * 2);
                ctx.stroke();
            }
            
            // Draw companion if active
            if (player.companion && player.powerUp) {
                // Draw companion
                ctx.fillStyle = "#2196F3"; // Blue
                
                // Head
                ctx.beginPath();
                ctx.arc(player.x - 40, player.y + player.width/2, player.width/2, 0, Math.PI * 2);
                ctx.fill();
                
                // Body
                ctx.fillRect(player.x - 40 - player.width/4, player.y + player.width, player.width/2, player.height - player.width);
                
                // Draw speech bubble
                const bubbleWidth = 100;
                const bubbleHeight = 30;
                const bubbleX = player.x - 90;
                const bubbleY = player.y - 40;
                
                // Draw bubble background
                ctx.fillStyle = "#FFFFFF";
                ctx.fillRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                ctx.strokeStyle = "#000000";
                ctx.strokeRect(bubbleX, bubbleY, bubbleWidth, bubbleHeight);
                
                // Draw text
                ctx.fillStyle = "#000000";
                ctx.font = "12px Arial";
                ctx.textAlign = "center";
                ctx.fillText("אני איתך!", bubbleX + bubbleWidth/2, bubbleY + bubbleHeight/2 + 4);
                ctx.textAlign = "start";
            }
            
            // Draw obstacles
            obstacles.forEach(obstacle => {
                switch(obstacle.type) {
                    case 'person':
                        // Draw person (negative influence)
                        ctx.fillStyle = "#3F51B5"; // Indigo
                        
                        // Head
                        ctx.beginPath();
                        ctx.arc(obstacle.x + obstacle.width/2, obstacle.y + obstacle.width/2, obstacle.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Body
                        ctx.fillRect(obstacle.x + obstacle.width/4, obstacle.y + obstacle.width, obstacle.width/2, obstacle.height - obstacle.width);
                        
                        // Arms
                        ctx.fillRect(obstacle.x - 5, obstacle.y + obstacle.width + 5, obstacle.width/4, obstacle.height/3);
                        ctx.fillRect(obstacle.x + obstacle.width - obstacle.width/4 + 5, obstacle.y + obstacle.width + 5, obstacle.width/4, obstacle.height/3);
                        
                        // Legs
                        ctx.fillRect(obstacle.x + obstacle.width/4, obstacle.y + obstacle.height - obstacle.height/3, obstacle.width/5, obstacle.height/3);
                        ctx.fillRect(obstacle.x + obstacle.width - obstacle.width/5 - obstacle.width/4, obstacle.y + obstacle.height - obstacle.height/3, obstacle.width/5, obstacle.height/3);
                        
                        // Angry face
                        ctx.strokeStyle = "#FFFFFF";
                        ctx.lineWidth = 2;
                        
                        // Mouth (frown)
                        ctx.beginPath();
                        ctx.arc(obstacle.x + obstacle.width/2, obstacle.y + obstacle.width/2 + 10, obstacle.width/4, 0.1 * Math.PI, 0.9 * Math.PI, true);
                        ctx.stroke();
                        
                        // Eyes (angry)
                        ctx.beginPath();
                        ctx.moveTo(obstacle.x + obstacle.width/3, obstacle.y + obstacle.width/2 - 8);
                        ctx.lineTo(obstacle.x + obstacle.width/3 - 5, obstacle.y + obstacle.width/2 - 3);
                        ctx.moveTo(obstacle.x + obstacle.width*2/3, obstacle.y + obstacle.width/2 - 8);
                        ctx.lineTo(obstacle.x + obstacle.width*2/3 + 5, obstacle.y + obstacle.width/2 - 3);
                        ctx.stroke();
                        break;
                        
                    case 'ad':
                        // Draw ad
                        ctx.fillStyle = "#E91E63"; // Pink
                        ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                        
                        // Draw ad icon
                        ctx.fillStyle = "#FFFFFF";
                        ctx.font = "20px Arial";
                        ctx.textAlign = "center";
                        ctx.fillText("$", obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2 + 7);
                        ctx.textAlign = "start";
                        break;
                        
                    case 'food':
                        // Draw food item
                        ctx.fillStyle = "#FF9800"; // Orange
                        ctx.beginPath();
                        ctx.arc(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height/2, obstacle.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Add some details to make it look like food
                        ctx.strokeStyle = "#FFFFFF";
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.moveTo(obstacle.x + 10, obstacle.y + obstacle.height/2);
                        ctx.lineTo(obstacle.x + obstacle.width - 10, obstacle.y + obstacle.height/2);
                        ctx.stroke();
                        
                        ctx.beginPath();
                        ctx.moveTo(obstacle.x + obstacle.width/2, obstacle.y + 10);
                        ctx.lineTo(obstacle.x + obstacle.width/2, obstacle.y + obstacle.height - 10);
                        ctx.stroke();
                        break;
                        
                    default:
                        // Default obstacle
                        ctx.fillStyle = "#9E9E9E"; // Grey
                        ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                        break;
                }
                
                // בוטלו בועות הטקסט מעל המכשולים - הטקסט מוצג רק בדיאלוג
            });
            // Draw powerups
            powerups.forEach(powerup => {
                let fillColor;
                
                switch(powerup.type) {
                    case 'money':
                        fillColor = "#FFD700"; // Gold
                        break;
                    case 'earlyRise':
                        fillColor = "#FFC107"; // Amber
                        break;
                    case 'earlySleep':
                        fillColor = "#7E57C2"; // Deep Purple
                        break;
                    case 'healthyFood':
                        fillColor = "#4CAF50"; // Green
                        break;
                    case 'exercise':
                        fillColor = "#F44336"; // Red
                        break;
                    case 'companion':
                        fillColor = "#2196F3"; // Blue
                        break;
                    default:
                        fillColor = "#FFEB3B"; // Yellow
                }
                
                // Draw the powerup with different shapes based on type
                if (powerup.type === 'money') {
                    // Draw coin for money
                    ctx.fillStyle = fillColor;
                    ctx.beginPath();
                    ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/2, powerup.width/2, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // הוספת נצנוץ למטבע
                    ctx.fillStyle = "#FFFFFF";
                    ctx.beginPath();
                    ctx.arc(powerup.x + powerup.width/2 - powerup.width/4, 
                             powerup.y + powerup.height/2 - powerup.height/4, 
                             powerup.width/8, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Shekel sign
                    ctx.fillStyle = "#FFFFFF";
                    ctx.font = "20px Arial";
                    ctx.textAlign = "center";
                    ctx.fillText("₪", powerup.x + powerup.width/2, powerup.y + powerup.height/2 + 7);
                    ctx.textAlign = "start";
                } else if (powerup.type === 'companion') {
                    // Draw friendly character
                    ctx.fillStyle = fillColor;
                    
                    // Head
                    ctx.beginPath();
                    ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/3, powerup.width/2.5, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // Body - heart shape
                    ctx.beginPath();
                    ctx.moveTo(powerup.x + powerup.width/2, powerup.y + powerup.height);
                    ctx.bezierCurveTo(
                        powerup.x + powerup.width, powerup.y + powerup.height * 0.6,
                        powerup.x + powerup.width, powerup.y + powerup.height * 0.4,
                        powerup.x + powerup.width/2, powerup.y + powerup.height * 0.5
                    );
                    ctx.bezierCurveTo(
                        powerup.x, powerup.y + powerup.height * 0.4,
                        powerup.x, powerup.y + powerup.height * 0.6,
                        powerup.x + powerup.width/2, powerup.y + powerup.height
                    );
                    ctx.fill();
                } else {
                    // Draw other powerups
                    ctx.fillStyle = fillColor;
                    
                    // Different shapes for different powerups
                    if (powerup.type === 'earlyRise') {
                        // Sun shape for early rise
                        const centerX = powerup.x + powerup.width/2;
                        const centerY = powerup.y + powerup.height/2;
                        const radius = powerup.width/2.5;
                        
                        // Sun circle
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Sun rays
                        ctx.strokeStyle = fillColor;
                        ctx.lineWidth = 3;
                        for (let i = 0; i < 8; i++) {
                            const angle = i * Math.PI / 4;
                            const rayLength = radius * 0.7;
                            
                            ctx.beginPath();
                            ctx.moveTo(
                                centerX + Math.cos(angle) * radius,
                                centerY + Math.sin(angle) * radius
                            );
                            ctx.lineTo(
                                centerX + Math.cos(angle) * (radius + rayLength),
                                centerY + Math.sin(angle) * (radius + rayLength)
                            );
                            ctx.stroke();
                        }
                    } else if (powerup.type === 'earlySleep') {
                        // Moon shape for early sleep
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/2, powerup.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Inner cut to make crescent
                        ctx.globalCompositeOperation = 'destination-out';
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width/2 + powerup.width/4, powerup.y + powerup.height/2, powerup.width/2.2, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.globalCompositeOperation = 'source-over';
                    } else if (powerup.type === 'healthyFood') {
                        // Apple shape for healthy food
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width/2, powerup.y + powerup.height/2 + powerup.height/10, powerup.width/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Stem
                        ctx.fillStyle = "#8D6E63";
                        ctx.fillRect(powerup.x + powerup.width/2 - 2, powerup.y + powerup.height/10, 4, 10);
                        
                        // Leaf
                        ctx.fillStyle = "#81C784";
                        ctx.beginPath();
                        ctx.ellipse(powerup.x + powerup.width/2 + 10, powerup.y + powerup.height/5, 8, 5, Math.PI/4, 0, Math.PI * 2);
                        ctx.fill();
                    } else if (powerup.type === 'exercise') {
                        // Dumbbell for exercise
                        ctx.fillStyle = "#78909C";
                        
                        // Left weight
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width * 0.2, powerup.y + powerup.height/2, powerup.width * 0.15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Right weight
                        ctx.beginPath();
                        ctx.arc(powerup.x + powerup.width * 0.8, powerup.y + powerup.height/2, powerup.width * 0.15, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Handle
                        ctx.fillRect(powerup.x + powerup.width * 0.2, powerup.y + powerup.height/2 - 5, powerup.width * 0.6, 10);
                    } else {
                        // Default star shape for other powerups
                        const cx = powerup.x + powerup.width/2;
                        const cy = powerup.y + powerup.height/2;
                        const spikes = 5;
                        const outerRadius = powerup.width/2;
                        const innerRadius = powerup.width/4;
                        
                        ctx.beginPath();
                        let rot = Math.PI / 2 * 3;
                        let x = cx;
                        let y = cy;
                        const step = Math.PI / spikes;
                        
                        ctx.moveTo(cx, cy - outerRadius);
                        for (let i = 0; i < spikes; i++) {
                            x = cx + Math.cos(rot) * outerRadius;
                            y = cy + Math.sin(rot) * outerRadius;
                            ctx.lineTo(x, y);
                            rot += step;
                            
                            x = cx + Math.cos(rot) * innerRadius;
                            y = cy + Math.sin(rot) * innerRadius;
                            ctx.lineTo(x, y);
                            rot += step;
                        }
                        ctx.lineTo(cx, cy - outerRadius);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
                
                // בוטלו בועות הטקסט מעל החיזוקים - הטקסט יוצג רק בעת התנגשות
            });
            
            // Draw month progress bar
            const progressWidth = 300;
            const progressHeight = 10;
            const progressX = (canvas.width - progressWidth) / 2;
            const progressY = 40;
            
            // Background
            ctx.fillStyle = "#E0E0E0";
            ctx.fillRect(progressX, progressY, progressWidth, progressHeight);
            
            // Progress
            const progress = currentMonthTimer / framesPerMonth;
            ctx.fillStyle = "#4CAF50";
            ctx.fillRect(progressX, progressY, progressWidth * progress, progressHeight);
            
            // Border
            ctx.strokeStyle = "#000000";
            ctx.strokeRect(progressX, progressY, progressWidth, progressHeight);
            
            // Health indicators
            // Physical health bar
            const healthBarWidth = 150;
            const healthBarHeight = 10;
            const healthBarX = 20;
            const healthBarY = 100;
            
            // Physical health background
            ctx.fillStyle = "#E0E0E0";
            ctx.fillRect(healthBarX, healthBarY, healthBarWidth, healthBarHeight);
            
            // Physical health fill
            ctx.fillStyle = "#4CAF50";
            ctx.fillRect(healthBarX, healthBarY, healthBarWidth * (stats.physicalHealth / 100), healthBarHeight);
            
            // Physical health border
            ctx.strokeStyle = "#000000";
            ctx.strokeRect(healthBarX, healthBarY, healthBarWidth, healthBarHeight);
            
            // Physical health label
            ctx.fillStyle = "#000000";
            ctx.font = "12px Arial";
            ctx.fillText("בריאות גופנית", healthBarX, healthBarY - 5);
            
            // Mental health bar
            const mentalBarY = healthBarY + 30;
            
            // Mental health background
            ctx.fillStyle = "#E0E0E0";
            ctx.fillRect(healthBarX, mentalBarY, healthBarWidth, healthBarHeight);
            
            // Mental health fill
            ctx.fillStyle = "#2196F3";
            ctx.fillRect(healthBarX, mentalBarY, healthBarWidth * (stats.mentalHealth / 100), healthBarHeight);
            
            // Mental health border
            ctx.strokeStyle = "#000000";
            ctx.strokeRect(healthBarX, mentalBarY, healthBarWidth, healthBarHeight);
            
            // Mental health label
            ctx.fillStyle = "#000000";
            ctx.font = "12px Arial";
            ctx.fillText("בריאות מנטלית", healthBarX, mentalBarY - 5);
            
            // Draw running animation if player is moving
            if (isMoving) {
                // Draw motion lines behind player
                ctx.strokeStyle = "rgba(255, 255, 255, 0.5)";
                ctx.lineWidth = 2;
                
                const motionX = player.x - 30;
                
                for (let i = 0; i < 5; i++) {
                    const lineY = player.y + 20 + i * 10;
                    const lineLength = 10 + i * 5;
                    
                    ctx.beginPath();
                    ctx.moveTo(motionX, lineY);
                    ctx.lineTo(motionX - lineLength, lineY);
                    ctx.stroke();
                }
            }
            
            // Draw game messages if any
            if (gameMessage && gameMessageTime > 0) {
                const alpha = Math.min(1, gameMessageTime / 100);
                ctx.globalAlpha = alpha;
                ctx.fillStyle = "#000000";
                ctx.font = "24px Arial";
                ctx.textAlign = "center";
                ctx.fillText(gameMessage, canvas.width/2, canvas.height/2);
                ctx.textAlign = "start";
                ctx.globalAlpha = 1.0;
            }
        }
        
        // Draw decorative clouds
        function drawClouds() {
            ctx.fillStyle = "#FFFFFF";
            
            // Create cloud positions based on time - slower moving for longer game feel
            const time = Date.now() / 20000;
            
            // Draw 3-5 clouds at different positions
            for (let i = 0; i < 5; i++) {
                const x = ((i * 300) + time * 30) % canvas.width;
                const y = 50 + i * 20;
                const scale = 0.5 + (i % 3) * 0.2;
                
                // Draw cloud shape
                drawCloud(x, y, scale);
            }
        }
        
        // Helper to draw a single cloud
        function drawCloud(x, y, scale) {
            const radiusX = 30 * scale;
            const radiusY = 20 * scale;
            
            ctx.beginPath();
            ctx.arc(x, y, radiusX, 0, Math.PI * 2);
            ctx.arc(x + radiusX, y - radiusY, radiusX, 0, Math.PI * 2);
            ctx.arc(x + radiusX * 2, y, radiusX, 0, Math.PI * 2);
            ctx.arc(x + radiusX, y + radiusY, radiusX, 0, Math.PI * 2);
            ctx.fill();
        }
        
        // Add achievement notification
        function addAchievement(text) {
            const achievementsDiv = document.getElementById('achievements');
            const achievement = document.createElement('div');
            achievement.className = 'achievement';
            achievement.textContent = text;
            achievementsDiv.appendChild(achievement);
            
            // Show achievements panel
            achievementsDiv.style.display = 'block';
            
            // Display popup message
            showPopupMessage(`הישג חדש: ${text}!`, 3000);
            
            // Add some bonus points
            score += 1000;
            updateDisplay();
        }
        
        // Update display
        function updateDisplay() {
            document.getElementById('score-display').textContent = `חיסכון: ${score.toLocaleString()} ש"ח`;
            document.getElementById('date-display').textContent = monthNames[currentMonth];
            
            // Update monthly stats
            document.getElementById('expenses').textContent = stats.expenses.toLocaleString();
            document.getElementById('income').textContent = stats.income.toLocaleString();
            document.getElementById('monthly-stats').style.display = 'block';
        }
        
        // Show job offer
        function showJobOffer() {
            gamePaused = true;
            jobOfferStage = 0;
            document.getElementById('job-offer').style.display = 'block';
        }
        
        // Show job offer followup
        function showJobOfferFollowup() {
            document.getElementById('job-offer').style.display = 'none';
            document.getElementById('followup-text').textContent = jobOfferTexts[jobOfferStage];
            document.getElementById('job-offer-followup').style.display = 'block';
        }
        
        // Game over
        function gameOver(reason) {
            gameRunning = false;
            document.getElementById('game-over-reason').textContent = reason;
            document.getElementById('final-score').textContent = score.toLocaleString();
            
            // Update game stats
            document.getElementById('months-played').textContent = stats.monthsPlayed;
            document.getElementById('powerups-collected').textContent = stats.powerupsCollected;
            document.getElementById('obstacles-avoided').textContent = stats.obstaclesFaced;
            
            document.getElementById('game-over').style.display = 'block';
        }
        
        // Win game
        function winGame() {
            gameRunning = false;
            
            // Update win stats
            document.getElementById('win-months').textContent = stats.monthsPlayed;
            document.getElementById('win-powerups').textContent = stats.powerupsCollected;
            document.getElementById('win-obstacles').textContent = stats.obstaclesFaced;
            
            document.getElementById('win-screen').style.display = 'block';
        }
        
        // Reset game
        function resetGame() {
            gameRunning = true;
            gamePaused = false;
            score = 0;
            currentMonth = 0;
            currentMonthTimer = 0;
            obstacles = [];
            powerups = [];
            pendingObstacles = [];
            isMoving = false;
            
            // Reset stats
            stats = {
                monthsPlayed: 0,
                powerupsCollected: 0,
                obstaclesAvoided: 0,
                obstaclesFaced: 0,
                expenses: 0,
                income: 5000,
                mentalHealth: 100,
                physicalHealth: 100
            };
            
            // Reset achievements
            achievements = {
                firstMonth: { earned: false, text: "הישרדות חודש ראשון" },
                saveHero: { earned: false, text: "חסכת 50,000 ש\"ח" },
                powerCollector: { earned: false, text: "אספת 10 חיזוקים" },
                resistanceMaster: { earned: false, text: "עמדת בפני 20 פיתויים" },
                mentalStrength: { earned: false, text: "שמרת על בריאות מנטלית חזקה" }
            };
            
            // Reset player
            player.powerUp = false;
            player.powerUpTime = 0;
            player.companion = false;
            player.currentSpeed = player.baseSpeed;
            
            // Adjust player size based on screen dimensions
            let scaleFactor = Math.min(window.innerWidth, window.innerHeight) / 500;
            scaleFactor = Math.max(0.5, Math.min(1.5, scaleFactor)); // Limit between 0.5 and 1.5
            player.width = 50 * scaleFactor;
            player.height = 80 * scaleFactor;
            
            // Update player position after size change
            player.y = ground.y - player.height;
            
            // Reset displays
            updateDisplay();
            updatePlayerCondition();
            
            // Clear achievements
            document.getElementById('achievements').innerHTML = '';
            document.getElementById('achievements').style.display = 'none';
            
            // Hide status displays
            document.getElementById('status-negative').style.display = 'none';
            document.getElementById('status-weight').style.display = 'none';
            
            // Hide power meter
            document.getElementById('power-meter').style.display = 'none';
            
            // Hide all dialogs
            document.getElementById('job-offer').style.display = 'none';
            document.getElementById('job-offer-followup').style.display = 'none';
            document.getElementById('obstacle-dialog').style.display = 'none';
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('win-screen').style.display = 'none';
            document.getElementById('tutorial-message').style.display = 'block';
            document.getElementById('movement-instruction').style.display = 'none';
            
            // Reset obstacle dialog tracking
            currentObstacle = null;
            lastObstacleTime = 0;
            persuasionStage = 0;
        }
        // Handle movement events
        function startMoving() {
            isMoving = true;
            document.getElementById('movement-instruction').style.display = 'none';
            
            if (moveTimer) {
                clearTimeout(moveTimer);
                moveTimer = null;
            }
        }
        
        function stopMoving() {
            isMoving = false;
        }
        
        // Handle window resize
        function handleResize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            ground.y = canvas.height * 0.8;
            ground.width = canvas.width;
            ground.height = canvas.height * 0.2;
            
            // Adjust player size and position based on screen dimensions
            let scaleFactor = Math.min(window.innerWidth, window.innerHeight) / 500;
            scaleFactor = Math.max(0.5, Math.min(1.5, scaleFactor)); // Limit between 0.5 and 1.5
            
            player.width = 50 * scaleFactor;
            player.height = 80 * scaleFactor;
            player.y = ground.y - player.height;
            
            // Adjust player base speed for screen size
            player.baseSpeed = 5 * scaleFactor;
            updatePlayerCondition(); // Update speed based on health
        }
        
        // Start game
        function startGame() {
            // Initialize the game
            resetGame();
            
            // Handle resize event
            window.removeEventListener('resize', handleResize);
            window.addEventListener('resize', handleResize);
            handleResize();
            
            // Show tutorial initially
            tutorialShown = true;
            document.getElementById('tutorial-message').style.display = 'block';
            
            // Game loop - run at 60fps
            const gameLoop = setInterval(() => {
                if (gameRunning) {
                    updateGame();
                }
            }, frameTime);
        }
        
        // Event listeners - keydown and keyup for space key
        document.addEventListener('keydown', function(event) {
            if (event.code === 'Space') {
                if (tutorialShown) {
                    tutorialShown = false;
                    document.getElementById('tutorial-message').style.display = 'none';
                    return;
                }
                
                if (gameRunning && !gamePaused) {
                    startMoving();
                }
            }
        });
        
        document.addEventListener('keyup', function(event) {
            if (event.code === 'Space') {
                if (gameRunning && !gamePaused) {
                    stopMoving();
                }
            }
        });
        
        // Canvas touch events for mobile
        canvas.addEventListener('touchstart', function(event) {
            event.preventDefault();
            
            if (tutorialShown) {
                tutorialShown = false;
                document.getElementById('tutorial-message').style.display = 'none';
                return;
            }
            
            if (gameRunning && !gamePaused) {
                startMoving();
            }
        });
        
        canvas.addEventListener('touchend', function(event) {
            event.preventDefault();
            
            if (gameRunning && !gamePaused) {
                stopMoving();
            }
        });
        
        // Canvas mouse events
        canvas.addEventListener('mousedown', function() {
            if (tutorialShown) {
                tutorialShown = false;
                document.getElementById('tutorial-message').style.display = 'none';
                return;
            }
            
            if (gameRunning && !gamePaused) {
                startMoving();
            }
        });
        
        canvas.addEventListener('mouseup', function() {
            if (gameRunning && !gamePaused) {
                stopMoving();
            }
        });
        
        // Leave canvas event - stop moving if cursor leaves canvas
        canvas.addEventListener('mouseleave', function() {
            if (gameRunning && !gamePaused) {
                stopMoving();
            }
        });
        
        // Obstacle dialog buttons
        document.getElementById('ignore-btn').addEventListener('click', function() {
            continuePersuasion(); // המשך לשלב השכנוע הבא או סיים את הדיאלוג
        });
        
        document.getElementById('accept-btn').addEventListener('click', function() {
            acceptObstacle(); // קבל את המכשול עם כל ההשלכות השליליות
        });
        
        // Start button click
        document.getElementById('start-btn').addEventListener('click', function() {
            tutorialShown = false;
            document.getElementById('tutorial-message').style.display = 'none';
        });
        
        // Job offer buttons
        document.getElementById('yes-btn').addEventListener('click', function() {
            gameOver("החלפת עבודה! איבדת את היציבות הכלכלית שלך.");
        });
        
        document.getElementById('no-btn').addEventListener('click', function() {
            showJobOfferFollowup();
        });
        
        document.getElementById('followup-yes-btn').addEventListener('click', function() {
            gameOver("החלפת עבודה! איבדת את היציבות הכלכלית שלך.");
        });
        
        document.getElementById('followup-no-btn').addEventListener('click', function() {
            jobOfferStage++;
            if (jobOfferStage < jobOfferTexts.length) {
                document.getElementById('followup-text').textContent = jobOfferTexts[jobOfferStage];
            } else {
                document.getElementById('job-offer-followup').style.display = 'none';
                gamePaused = false;
                
                // Reward player for resisting temptation
                score += 1000;
                // Also boost mental health
                stats.mentalHealth = Math.min(100, stats.mentalHealth + 10);
                updatePlayerCondition();
                showPopupMessage("קיבלת 1,000 ש\"ח בונוס על ההתמדה!", 2000);
                updateDisplay();
            }
        });
        
        // Game over buttons
        document.getElementById('restart-btn').addEventListener('click', function() {
            resetGame();
        });
        
        document.getElementById('play-again-btn').addEventListener('click', function() {
            resetGame();
        });
        
        // Helper function to schedule obstacles
        function scheduleObstacle(delayMs) {
            pendingObstacles.push({
                time: Date.now() + delayMs
            });
        }
        
        // Mobile-specific optimizations
        function optimizeForMobile() {
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            
            if (isMobile) {
                // Reduce visual effects for better performance
                const style = document.createElement('style');
                style.textContent = `
                    @media (max-width: 768px) {
                        #game-canvas {
                            image-rendering: optimizeSpeed;
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }
        
        // Load game assets
        function preloadAssets() {
            // No external assets needed in this version
            return Promise.resolve();
        }
        
        // Initialize the game when the page loads
        window.onload = function() {
            optimizeForMobile();
            preloadAssets().then(() => {
                startGame();
            }).catch(error => {
                console.error('Failed to load game assets:', error);
                // Start anyway
                startGame();
            });
        };
    </script>
</body>
</html>
